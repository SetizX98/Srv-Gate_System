<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora Científica - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    :root {
      --scale-factor: 1;
      --button-height: calc(60px * var(--scale-factor));
      --font-size-expression: calc(28px * var(--scale-factor));
      --font-size-result: calc(16px * var(--scale-factor));
      --font-size-button: calc(18px * var(--scale-factor));
      --screen-min-height: calc(80px * var(--scale-factor));
      --corner-size: clamp(40px, calc(60px * var(--scale-factor)), 70px);
      --light-blue: rgba(64, 156, 255, 0.85);
      --dark-blue: rgba(42, 42, 74, 0.85);
      --blue-gradient: linear-gradient(145deg, var(--light-blue), rgba(0, 102, 204, 0.85));
      --dark-gradient: linear-gradient(145deg, var(--dark-blue), rgba(32, 32, 64, 0.85));
    }
    
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      width: 100vw;
      height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Cambiado para tener más separación entre pantalla y botones */
      padding: calc(var(--corner-size) * 0.8) max(15px, calc(20px * var(--scale-factor))) calc(var(--corner-size) * 0.8);
    }
    
    /* Partículas decorativas - MEJORADAS */
    .particles {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 0;
      overflow: hidden;
    }
    
    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 50%;
      will-change: transform, opacity;
      transition: opacity 0.3s ease;
      box-shadow: 0 0 6px currentColor;
    }
    
    /* PANTALLA - EN LA PARTE SUPERIOR */
    .screen {
      width: 100%;
      max-width: 460px;
      background: rgba(10, 20, 30, 0.9);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: max(15px, calc(20px * var(--scale-factor)));
      text-align: right;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 
        inset 0 0 15px rgba(0, 0, 0, 0.5),
        0 8px 20px rgba(0, 0, 0, 0.3);
      min-height: var(--screen-min-height);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      overflow: hidden;
      z-index: 2;
      /* Añadido margen inferior para separar de los botones */
      margin-bottom: max(20px, calc(30px * var(--scale-factor)));
      align-self: center;
      flex-shrink: 0;
    }
    
    /* ECUACIÓN */
    .expression {
      color: rgba(255, 255, 255, 0.95);
      font-size: var(--font-size-expression);
      font-weight: 600;
      word-break: break-all;
      text-align: right;
      overflow-x: auto;
      white-space: nowrap;
      margin-bottom: 5px;
      flex-shrink: 0;
      min-height: calc(35px * var(--scale-factor));
    }
    
    /* RESULTADO */
    .result {
      color: rgba(255, 255, 255, 0.7);
      font-size: var(--font-size-result);
      font-weight: 400;
      text-shadow: 0 0 6px rgba(0, 200, 255, 0.4);
      word-break: break-all;
      text-align: right;
      overflow-x: auto;
      font-style: italic;
      flex-shrink: 0;
      min-height: calc(20px * var(--scale-factor));
    }
    
    .preview-indicator {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      font-style: normal;
    }
    
    /* CONTENEDOR DE BOTONES - CON MÁS SEPARACIÓN */
    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(8, var(--button-height));
      gap: calc(12px * var(--scale-factor)); /* Aumentado de 10px a 12px */
      width: 100%;
      max-width: 460px;
      background: transparent;
      z-index: 2;
      /* Ocupa el espacio disponible hasta el corner inferior */
      flex: 1;
      min-height: 0;
      /* Asegurar que llegue hasta abajo */
      margin-top: 0;
      align-self: center;
    }
    
    /* BOTONES GENERALES */
    .btn {
      height: 100%;
      width: 100%;
      border: none;
      border-radius: 12px;
      font-size: var(--font-size-button);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: manipulation;
      color: white;
      box-shadow: 
        0 4px 0 rgba(0, 0, 0, 0.4),
        inset 0 1px 3px rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(8px);
    }
    
    .btn:active {
      transform: translateY(4px) scale(0.98);
      box-shadow: 
        0 0 0 rgba(0, 0, 0, 0.3),
        inset 0 1px 3px rgba(255, 255, 255, 0.15);
    }
    
    /* FILAS 1-3: AZUL CLARO */
    .row-1 .btn,
    .row-2 .btn,
    .row-3 .btn {
      background: var(--blue-gradient);
    }
    
    /* FILAS 4-8: AZUL FUERTE */
    .row-4 .btn,
    .row-5 .btn,
    .row-6 .btn,
    .row-7 .btn,
    .row-8 .btn {
      background: var(--dark-gradient);
    }
    
    /* BOTONES ESPECIALES */
    .btn-equals {
      background: linear-gradient(145deg, rgba(76, 175, 80, 0.9), rgba(46, 125, 50, 0.9));
    }
    
    .btn-clear {
      background: linear-gradient(145deg, rgba(255, 68, 68, 0.9), rgba(204, 0, 0, 0.9));
    }
    
    /* FILAS PARA ORGANIZACIÓN */
    .row-1, .row-2, .row-3, .row-4, .row-5, .row-6, .row-7, .row-8 {
      display: contents;
    }
    
    /* ELEMENTOS DECORATIVOS DE ESQUINA */
    .corner-decoration {
      position: absolute;
      width: var(--corner-size);
      height: var(--corner-size);
      z-index: 1;
    }
    
    .corner-top-left {
      top: max(5px, calc(10px * var(--scale-factor)));
      left: max(5px, calc(10px * var(--scale-factor)));
      border-top: 3px solid rgba(100, 200, 255, 0.9);
      border-left: 3px solid rgba(100, 200, 255, 0.9);
      border-radius: 12px 0 0 0;
    }
    
    .corner-bottom-right {
      bottom: max(5px, calc(10px * var(--scale-factor)));
      right: max(5px, calc(10px * var(--scale-factor)));
      border-bottom: 3px solid rgba(100, 200, 255, 0.9);
      border-right: 3px solid rgba(100, 200, 255, 0.9);
      border-radius: 0 0 12px 0;
    }
    
    /* MEDIA QUERIES AJUSTADAS */
    @media (min-height: 900px) {
      :root {
        --scale-factor: 1.1;
      }
    }
    
    @media (max-height: 700px) {
      :root {
        --scale-factor: 0.9;
      }
      body {
        padding: calc(var(--corner-size) * 0.7) max(12px, calc(16px * var(--scale-factor))) calc(var(--corner-size) * 0.7);
      }
      .screen {
        margin-bottom: max(15px, calc(25px * var(--scale-factor)));
      }
    }
    
    @media (max-height: 600px) {
      :root {
        --scale-factor: 0.8;
      }
      body {
        padding: calc(var(--corner-size) * 0.6) max(10px, calc(14px * var(--scale-factor))) calc(var(--corner-size) * 0.6);
      }
      .screen {
        max-width: 420px;
        margin-bottom: max(12px, calc(20px * var(--scale-factor)));
      }
      .buttons-grid {
        max-width: 420px;
        gap: calc(10px * var(--scale-factor));
      }
    }
    
    @media (max-height: 500px) {
      :root {
        --scale-factor: 0.7;
      }
      body {
        padding: calc(var(--corner-size) * 0.5) max(8px, calc(12px * var(--scale-factor))) calc(var(--corner-size) * 0.5);
      }
      .screen {
        max-width: 380px;
        margin-bottom: max(10px, calc(15px * var(--scale-factor)));
      }
      .buttons-grid {
        max-width: 380px;
        gap: calc(8px * var(--scale-factor));
      }
    }
    
    @media (max-width: 400px) {
      :root {
        --scale-factor: 0.9;
      }
      body {
        padding: calc(var(--corner-size) * 0.8) max(12px, calc(15px * var(--scale-factor))) calc(var(--corner-size) * 0.8);
      }
    }
    
    @media (max-width: 350px) and (max-height: 600px) {
      :root {
        --scale-factor: 0.75;
      }
    }
    
    @media (max-width: 350px) and (max-height: 500px) {
      :root {
        --scale-factor: 0.65;
      }
      .screen {
        max-width: 95%;
      }
      .buttons-grid {
        max-width: 95%;
      }
    }
    
    @media (orientation: landscape) and (max-height: 500px) {
      body {
        flex-direction: row;
        justify-content: center;
        align-items: center;
        padding: max(10px, calc(15px * var(--scale-factor)));
        gap: max(25px, calc(35px * var(--scale-factor)));
      }
      
      .screen {
        flex: 0 0 35%;
        max-height: 80%;
        max-width: 35%;
        margin: 0;
        margin-bottom: 0;
      }
      
      .buttons-grid {
        flex: 0 0 60%;
        height: 100%;
        max-width: 60%;
        margin: 0;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(8, 1fr);
      }
    }
    
    @supports (-webkit-touch-callout: none) {
      body {
        height: -webkit-fill-available;
      }
    }
  </style>
</head>
<body>
  <!-- Partículas decorativas -->
  <div class="particles" id="particles"></div>
  
  <!-- Elementos decorativos de esquina -->
  <div class="corner-decoration corner-top-left"></div>
  <div class="corner-decoration corner-bottom-right"></div>
  
  <!-- PANTALLA EN LA PARTE SUPERIOR -->
  <div class="screen" id="screen">
    <div class="expression" id="expression"></div>
    <div class="result" id="result"><span class="preview-indicator">preview:</span> <span id="previewValue">0</span></div>
  </div>
  
  <!-- CONTENEDOR DE BOTONES - CON MÁS SEPARACIÓN DE LA PANTALLA -->
  <div class="buttons-grid">
    <!-- Fila 1: √ π ^ ! (Azul Claro) -->
    <div class="row-1">
      <button class="btn" data-action="sqrt">√</button>
      <button class="btn" data-action="pi">π</button>
      <button class="btn" data-action="pow">^</button>
      <button class="btn" data-action="factorial">!</button>
    </div>
    
    <!-- Fila 2: Deg sin cos tan (Azul Claro) -->
    <div class="row-2">
      <button class="btn" data-action="deg">Deg</button>
      <button class="btn" data-action="sin">sin</button>
      <button class="btn" data-action="cos">cos</button>
      <button class="btn" data-action="tan">tan</button>
    </div>
    
    <!-- Fila 3: Inv e ln log (Azul Claro) -->
    <div class="row-3">
      <button class="btn" data-action="inv">Inv</button>
      <button class="btn" data-action="e">e</button>
      <button class="btn" data-action="ln">ln</button>
      <button class="btn" data-action="log">log</button>
    </div>
    
    <!-- Fila 4: AC () % ÷ (Azul Fuerte) -->
    <div class="row-4">
      <button class="btn btn-clear" data-action="clear">AC</button>
      <button class="btn" data-action="parenthesis">( )</button>
      <button class="btn" data-action="percentage">%</button>
      <button class="btn" data-action="divide">÷</button>
    </div>
    
    <!-- Fila 5: 7 8 9 × (Azul Fuerte) -->
    <div class="row-5">
      <button class="btn" data-value="7">7</button>
      <button class="btn" data-value="8">8</button>
      <button class="btn" data-value="9">9</button>
      <button class="btn" data-action="multiply">×</button>
    </div>
    
    <!-- Fila 6: 4 5 6 - (Azul Fuerte) -->
    <div class="row-6">
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
      <button class="btn" data-action="subtract">-</button>
    </div>
    
    <!-- Fila 7: 1 2 3 + (Azul Fuerte) -->
    <div class="row-7">
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-action="add">+</button>
    </div>
    
    <!-- Fila 8: 0 . ⌫ = (Azul Fuerte) -->
    <div class="row-8">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value=".">.</button>
      <button class="btn" data-action="backspace">⌫</button>
      <button class="btn btn-equals" data-action="equals">=</button>
    </div>
  </div>
  
  <script>
    // El código JavaScript permanece igual
    document.addEventListener('DOMContentLoaded', function() {
      // Elementos de la calculadora
      const expressionElement = document.getElementById('expression');
      const resultElement = document.getElementById('result');
      const previewValueElement = document.getElementById('previewValue');
      const particlesContainer = document.getElementById('particles');
      
      // Estado de la calculadora
      let currentExpression = '';
      let currentPreview = '0';
      let parenthesisOpen = false;
      let lastSqrtIndex = -1;
      let previewTimeout = null;
      let isDeg = true;
      let isInv = false;
      
      // ================================================
      // FUNCIÓN DE AJUSTE AUTOMÁTICO DE TAMAÑO
      // ================================================
      function calculateScaleFactor() {
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        
        let scale = viewportHeight / 800;
        
        if (viewportHeight >= 900) {
          scale = 1.1;
        } else if (viewportHeight >= 800) {
          scale = 1;
        } else if (viewportHeight >= 700) {
          scale = 0.9;
        } else if (viewportHeight >= 600) {
          scale = 0.8;
        } else if (viewportHeight >= 500) {
          scale = 0.7;
        } else {
          scale = 0.6;
        }
        
        if (viewportWidth < 400) {
          scale = Math.min(scale, 0.9);
        }
        
        if (viewportWidth < 350) {
          scale = Math.min(scale, 0.75);
        }
        
        if (window.innerHeight < 500 && window.innerWidth > window.innerHeight) {
          scale = Math.min(scale, 0.7);
        }
        
        scale = Math.max(scale, 0.55);
        scale = Math.min(scale, 1.2);
        
        return scale;
      }
      
      function updateScale() {
        const scale = calculateScaleFactor();
        document.documentElement.style.setProperty('--scale-factor', scale);
        document.documentElement.style.setProperty('--corner-size', 
          `clamp(40px, calc(60px * ${scale}), 70px)`);
      }
      
      // Inicializar y actualizar en cambios de tamaño
      updateScale();
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateScale, 100);
      });
      
      window.addEventListener('orientationchange', function() {
        setTimeout(updateScale, 200);
      });
      
      // SISTEMA DE PARTÍCULAS - MEJORADO
      function createParticles() {
        const particles = [];
        const colors = [
          'rgba(255, 107, 107, 0.4)',
          'rgba(255, 255, 255, 0.3)',
          'rgba(255, 142, 83, 0.35)',
          'rgba(0, 136, 255, 0.3)',
          'rgba(255, 215, 0, 0.3)',
          'rgba(138, 43, 226, 0.3)',
          'rgba(0, 255, 204, 0.25)',
          'rgba(255, 0, 255, 0.25)',
        ];
        
        const containerWidth = particlesContainer.clientWidth;
        const containerHeight = particlesContainer.clientHeight;
        
        // Aumentado a 25 partículas
        for (let i = 0; i < 25; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          
          // Tamaño entre 3-16px
          const size = Math.random() * 13 + 3;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          
          particle.style.background = colors[Math.floor(Math.random() * colors.length)];
          
          // Añadir brillo a algunas partículas
          if (Math.random() > 0.7) {
            particle.style.boxShadow = '0 0 10px currentColor';
          }
          
          const initialX = Math.random() * (containerWidth - size);
          const initialY = Math.random() * (containerHeight - size);
          
          particle.style.left = `${initialX}px`;
          particle.style.top = `${initialY}px`;
          
          // Velocidad aumentada
          const speed = Math.random() * 0.7 + 0.15;
          const angle = Math.random() * Math.PI * 2;
          
          const velocityX = Math.cos(angle) * speed;
          const velocityY = Math.sin(angle) * speed;
          
          // Rotación aumentada
          const rotationSpeed = (Math.random() - 0.5) * 1.5;
          let rotation = 0;
          
          particlesContainer.appendChild(particle);
          
          particles.push({
            element: particle,
            x: initialX,
            y: initialY,
            size: size,
            velocityX: velocityX,
            velocityY: velocityY,
            rotation: rotation,
            rotationSpeed: rotationSpeed
          });
        }
        
        function animateParticles() {
          const currentWidth = particlesContainer.clientWidth;
          const currentHeight = particlesContainer.clientHeight;
          
          for (const p of particles) {
            p.x += p.velocityX;
            p.y += p.velocityY;
            
            p.rotation += p.rotationSpeed;
            
            // Rebote en los bordes
            if (p.x <= 0) {
              p.x = 0;
              p.velocityX = Math.abs(p.velocityX);
            } else if (p.x >= currentWidth - p.size) {
              p.x = currentWidth - p.size;
              p.velocityX = -Math.abs(p.velocityX);
            }
            
            if (p.y <= 0) {
              p.y = 0;
              p.velocityY = Math.abs(p.velocityY);
            } else if (p.y >= currentHeight - p.size) {
              p.y = currentHeight - p.size;
              p.velocityY = -Math.abs(p.velocityY);
            }
            
            // Aplicar movimiento y rotación
            p.element.style.left = `${p.x}px`;
            p.element.style.top = `${p.y}px`;
            p.element.style.transform = `rotate(${p.rotation}deg)`;
            
            // Efecto de parpadeo sutil
            if (Math.random() > 0.95) {
              p.element.style.opacity = Math.random() * 0.5 + 0.5;
              setTimeout(() => {
                p.element.style.opacity = 1;
              }, 100);
            }
          }
          
          requestAnimationFrame(animateParticles);
        }
        
        animateParticles();
      }
      
      // ACTUALIZAR LA PANTALLA DE LA CALCULADORA
      function updateScreen() {
        expressionElement.textContent = currentExpression || '';
        previewValueElement.textContent = currentPreview;
        
        if (currentPreview === '0' || currentPreview === '') {
          resultElement.querySelector('.preview-indicator').style.display = 'none';
        } else {
          resultElement.querySelector('.preview-indicator').style.display = 'inline';
        }
      }
      
      // AGREGAR VALOR A LA EXPRESIÓN
      function addToExpression(value) {
        currentExpression += value;
        updateScreen();
        updatePreview();
      }
      
      // LIMPIAR TODO
      function clearAll() {
        currentExpression = '';
        currentPreview = '0';
        parenthesisOpen = false;
        lastSqrtIndex = -1;
        
        if (previewTimeout) {
          clearTimeout(previewTimeout);
          previewTimeout = null;
        }
        
        updateScreen();
      }
      
      // BORRAR ÚLTIMO CARÁCTER
      function backspace() {
        if (currentExpression.slice(-2) === '√(') {
          lastSqrtIndex = -1;
        }
        
        if (currentExpression.slice(-1) === '(') {
          parenthesisOpen = false;
        } else if (currentExpression.slice(-1) === ')') {
          parenthesisOpen = true;
        }
        
        currentExpression = currentExpression.slice(0, -1);
        updateScreen();
        updatePreview();
      }
      
      // MANEJAR PARÉNTESIS
      function handleParenthesis() {
        if (parenthesisOpen) {
          addToExpression(')');
          parenthesisOpen = false;
        } else {
          addToExpression('(');
          parenthesisOpen = true;
        }
      }
      
      // FUNCIÓN PARA CERRAR PARÉNTESIS AUTOMÁTICAMENTE
      function balanceParentheses(expression) {
        let openCount = (expression.match(/\(/g) || []).length;
        let closeCount = (expression.match(/\)/g) || []).length;
        
        for (let i = 0; i < (openCount - closeCount); i++) {
          expression += ')';
        }
        
        return expression;
      }
      
      // FUNCIÓN ESPECIAL PARA RAÍZ CUADRADA
      function handleSquareRoot() {
        if (lastSqrtIndex !== -1) {
          const afterSqrt = currentExpression.substring(lastSqrtIndex);
          if (!afterSqrt.includes(')')) {
            addToExpression(')');
            lastSqrtIndex = -1;
          }
        }
        
        addToExpression('√(');
        lastSqrtIndex = currentExpression.length - 2;
        parenthesisOpen = true;
      }
      
      // TOGGLE GRADOS/RADIANES
      function toggleDeg() {
        isDeg = !isDeg;
        const degButtons = document.querySelectorAll('[data-action="deg"]');
        degButtons.forEach(btn => {
          btn.textContent = isDeg ? 'Deg' : 'Rad';
        });
      }
      
      // TOGGLE FUNCIONES INVERSAS
      function toggleInv() {
        isInv = !isInv;
        const invButtons = document.querySelectorAll('[data-action="inv"]');
        const sinButtons = document.querySelectorAll('[data-action="sin"]');
        const cosButtons = document.querySelectorAll('[data-action="cos"]');
        const tanButtons = document.querySelectorAll('[data-action="tan"]');
        
        invButtons.forEach(btn => {
          btn.style.backgroundColor = isInv ? '#ff5a75' : '';
        });
        
        if (isInv) {
          sinButtons.forEach(btn => btn.textContent = 'sin⁻¹');
          cosButtons.forEach(btn => btn.textContent = 'cos⁻¹');
          tanButtons.forEach(btn => btn.textContent = 'tan⁻¹');
        } else {
          sinButtons.forEach(btn => btn.textContent = 'sin');
          cosButtons.forEach(btn => btn.textContent = 'cos');
          tanButtons.forEach(btn => btn.textContent = 'tan');
        }
      }
      
      // ACTUALIZAR PREVISUALIZACIÓN EN TIEMPO REAL
      function updatePreview() {
        if (previewTimeout) {
          clearTimeout(previewTimeout);
        }
        
        if (!currentExpression.trim()) {
          currentPreview = '0';
          updateScreen();
          return;
        }
        
        previewTimeout = setTimeout(() => {
          try {
            let expressionToEval = currentExpression;
            
            expressionToEval = balanceParentheses(expressionToEval);
            
            // Reemplazar símbolos por funciones mathjs
            expressionToEval = expressionToEval
              .replace(/×/g, '*')
              .replace(/÷/g, '/')
              .replace(/π/g, 'pi')
              .replace(/√/g, 'sqrt')
              .replace(/\^/g, '^')
              .replace(/e/g, 'e');
            
            // Manejar funciones trigonométricas
            if (isInv) {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'asin')
                .replace(/cos/g, 'acos')
                .replace(/tan/g, 'atan');
            } else {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'sin')
                .replace(/cos/g, 'cos')
                .replace(/tan/g, 'tan');
            }
            
            // Convertir grados a radianes si es necesario
            if (isDeg && !isInv) {
              expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
                function(match, func, angle) {
                  return func + '(' + angle + '*pi/180)';
                });
            }
            
            expressionToEval = expressionToEval
              .replace(/ln/g, 'log')
              .replace(/log/g, 'log10');
            
            expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
              return `factorial(${num})`;
            });
            
            expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
              return `(${num}/100)`;
            });
            
            const result = math.evaluate(expressionToEval);
            
            let formattedResult = result.toString();
            
            if (formattedResult.length > 12 && !isNaN(result)) {
              formattedResult = Number(result).toPrecision(10);
            }
            
            currentPreview = formattedResult;
            updateScreen();
            
          } catch (error) {
            currentPreview = '...';
            updateScreen();
          }
        }, 200);
      }
      
      // CALCULAR RESULTADO FINAL
      function calculateResult() {
        if (!currentExpression) return;
        
        try {
          let expressionToEval = currentExpression;
          
          expressionToEval = balanceParentheses(expressionToEval);
          
          // Reemplazar símbolos por funciones mathjs
          expressionToEval = expressionToEval
            .replace(/×/g, '*')
            .replace(/÷/g, '/')
            .replace(/π/g, 'pi')
            .replace(/√/g, 'sqrt')
            .replace(/\^/g, '^')
            .replace(/e/g, 'e');
          
          // Manejar funciones trigonométricas
          if (isInv) {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'asin')
              .replace(/cos/g, 'acos')
              .replace(/tan/g, 'atan');
          } else {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'sin')
              .replace(/cos/g, 'cos')
              .replace(/tan/g, 'tan');
          }
          
          // Convertir grados a radianes si es necesario
          if (isDeg && !isInv) {
            expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
              function(match, func, angle) {
                return func + '(' + angle + '*pi/180)';
              });
          }
          
          expressionToEval = expressionToEval
            .replace(/ln/g, 'log')
            .replace(/log/g, 'log10');
          
          expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
            return `factorial(${num})`;
          });
          
          expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
            return `(${num}/100)`;
          });
          
          const result = math.evaluate(expressionToEval);
          
          // Convertir resultado de radianes a grados si es necesario
          let finalResult = result;
          if (isDeg && isInv) {
            finalResult = result * 180 / Math.PI;
          }
          
          let formattedResult = finalResult.toString();
          
          if (formattedResult.length > 12 && !isNaN(finalResult)) {
            formattedResult = Number(finalResult).toPrecision(10);
          }
          
          currentExpression = formattedResult;
          currentPreview = '0';
          parenthesisOpen = false;
          lastSqrtIndex = -1;
          
          updateScreen();
          
        } catch (error) {
          console.error('Error en cálculo:', error);
          currentPreview = 'Error';
          updateScreen();
          
          setTimeout(() => {
            currentPreview = '0';
            currentExpression = '';
            parenthesisOpen = false;
            lastSqrtIndex = -1;
            updateScreen();
          }, 1500);
        }
      }
      
      // MANEJAR CLICS EN BOTONES
      function handleButtonClick(event) {
        const button = event.target.closest('.btn');
        if (!button) return;
        
        button.style.transform = 'translateY(4px) scale(0.98)';
        setTimeout(() => {
          button.style.transform = '';
        }, 150);
        
        const value = button.getAttribute('data-value');
        const action = button.getAttribute('data-action');
        
        if (value) {
          addToExpression(value);
        } else if (action) {
          switch(action) {
            case 'clear':
              clearAll();
              break;
            case 'backspace':
              backspace();
              break;
            case 'equals':
              calculateResult();
              break;
            case 'divide':
              addToExpression('÷');
              break;
            case 'multiply':
              addToExpression('×');
              break;
            case 'add':
              addToExpression('+');
              break;
            case 'subtract':
              addToExpression('-');
              break;
            case 'parenthesis':
              handleParenthesis();
              break;
            case 'percentage':
              addToExpression('%');
              break;
            case 'sqrt':
              handleSquareRoot();
              break;
            case 'pi':
              addToExpression('π');
              break;
            case 'e':
              addToExpression('e');
              break;
            case 'pow':
              addToExpression('^');
              break;
            case 'factorial':
              addToExpression('!');
              break;
            case 'sin':
              addToExpression(isInv ? 'asin(' : 'sin(');
              parenthesisOpen = true;
              break;
            case 'cos':
              addToExpression(isInv ? 'acos(' : 'cos(');
              parenthesisOpen = true;
              break;
            case 'tan':
              addToExpression(isInv ? 'atan(' : 'tan(');
              parenthesisOpen = true;
              break;
            case 'ln':
              addToExpression('ln(');
              parenthesisOpen = true;
              break;
            case 'log':
              addToExpression('log(');
              parenthesisOpen = true;
              break;
            case 'deg':
              toggleDeg();
              break;
            case 'inv':
              toggleInv();
              break;
          }
        }
      }
      
      // INICIALIZAR
      function initialize() {
        const buttonsGrid = document.querySelector('.buttons-grid');
        buttonsGrid.addEventListener('click', handleButtonClick);
        
        // Soporte para teclado físico
        document.addEventListener('keydown', function(event) {
          const key = event.key;
          
          if (['+', '-', '*', '/', 'Enter', 'Escape'].includes(key)) {
            event.preventDefault();
          }
          
          if (key >= '0' && key <= '9') {
            addToExpression(key);
          } else if (key === '.') {
            addToExpression('.');
          } else if (key === '+') {
            addToExpression('+');
          } else if (key === '-') {
            addToExpression('-');
          } else if (key === '*') {
            addToExpression('×');
          } else if (key === '/') {
            addToExpression('÷');
          } else if (key === 'Enter' || key === '=') {
            calculateResult();
          } else if (key === 'Escape' || key === 'Delete') {
            clearAll();
          } else if (key === 'Backspace') {
            backspace();
          } else if (key === '(' || key === ')') {
            handleParenthesis();
          } else if (key === '%') {
            addToExpression('%');
          }
        });
      }
      
      // Verificar si estamos en Telegram WebApp
      const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
      
      if (isTelegramWebApp) {
        Telegram.WebApp.ready();
        console.log('✅ Calculadora Científica para Telegram inicializada');
        Telegram.WebApp.expand();
        Telegram.WebApp.setBackgroundColor('#0f0c29');
        Telegram.WebApp.setHeaderColor('#0f0c29');
      }
      
      // INICIALIZAR TODO
      createParticles();
      initialize();
      updateScreen();
      
      // Ajustar para dispositivos iOS
      if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
        document.body.style.height = 'calc(var(--vh, 1vh) * 100)';
        
        const setVH = () => {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
        
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', setVH);
      }
    });
  </script>
</body>
</html>
