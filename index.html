<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora Científica - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1e1e2e, #2d2d44);
      color: #fff;
      padding: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    .calculator {
      width: 100%;
      max-width: 420px;
      background-color: #2a2a3e;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid #3a3a4e;
    }
    
    .display {
      background-color: #1a1a2e;
      padding: 24px 20px;
      text-align: right;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .expression {
      color: rgba(255, 255, 255, 0.95);
      font-size: 2.2rem;
      font-weight: 500;
      word-break: break-all;
      text-align: right;
      min-height: 35px;
      overflow-x: auto;
      white-space: nowrap;
      margin-bottom: 4px;
    }
    
    .result {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.3rem;
      font-weight: 400;
      word-break: break-all;
      text-align: right;
      overflow-x: auto;
      line-height: 1.3;
      min-height: 25px;
      overflow-y: auto;
      max-height: 60px;
      margin-bottom: 8px;
    }
    
    .result::-webkit-scrollbar {
      width: 4px;
    }
    
    .result::-webkit-scrollbar-track {
      background: #1a1a2e;
    }
    
    .result::-webkit-scrollbar-thumb {
      background: #4cc9f0;
      border-radius: 2px;
    }
    
    .toggle-scientific {
      display: flex;
      justify-content: center;
      padding: 10px 0;
      background: linear-gradient(to bottom, #3a3a5e, #2d2d4a);
      cursor: pointer;
      color: #a5b1c2;
      font-size: 0.9rem;
      transition: background 0.3s;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .toggle-scientific:hover {
      background: linear-gradient(to bottom, #44446e, #35355a);
    }
    
    .buttons-container {
      display: flex;
      flex-direction: column;
    }
    
    .scientific-buttons {
      background: linear-gradient(to bottom, #2d2d44, #252536);
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-height: 350px;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .scientific-buttons.collapsed {
      max-height: 0;
      padding: 0;
      border-bottom: none;
    }
    
    /* Estilo para el interruptor de vibración dentro del panel científico */
    .vibration-toggle-row {
      grid-column: 1 / -1; /* Ocupa todas las 4 columnas */
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px 0;
      margin-top: 5px;
    }
    
    .vibration-toggle-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #a5b1c2;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #2d2d4a;
      transition: .3s;
      border-radius: 20px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4cc9f0;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .basic-buttons {
      background: linear-gradient(to bottom, #252536, #1e1e2e);
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    
    .button {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 56px;
      border-radius: 16px;
      font-size: 1.4rem;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
      border: none;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      touch-action: manipulation;
    }
    
    .button:active {
      transform: translateY(2px) scale(0.98);
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
    }
    
    .scientific-btn {
      background: linear-gradient(145deg, #3a3a5e, #2d2d4a);
      font-size: 1.2rem;
    }
    
    .scientific-btn:hover {
      background: linear-gradient(145deg, #44446e, #35355a);
    }
    
    .number {
      background: linear-gradient(145deg, #2a2a3e, #1e1e2e);
    }
    
    .number:hover {
      background: linear-gradient(145deg, #34344e, #282838);
    }
    
    .operator {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .operator:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .parenthesis {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .parenthesis:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .percentage {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .percentage:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .equals {
      background: linear-gradient(145deg, #f72585, #d11475);
      color: white;
      font-weight: 600;
    }
    
    .equals:hover {
      background: linear-gradient(145deg, #ff35a5, #e12485);
    }
    
    .clear {
      background: linear-gradient(145deg, #ff6b6b, #e64c4c);
      color: white;
      font-weight: 600;
    }
    
    .clear:hover {
      background: linear-gradient(145deg, #ff7b7b, #f65c5c);
    }
    
    .delete {
      background: linear-gradient(145deg, #ff6b6b, #e64c4c);
      color: white;
      font-weight: 600;
    }
    
    .delete:hover {
      background: linear-gradient(145deg, #ff7b7b, #f65c5c);
    }
    
    @media (min-width: 768px) {
      .scientific-buttons {
        max-height: 550px !important; /* Aumentado para modo horizontal */
        padding: 15px !important;
      }
      
      .toggle-scientific {
        display: none;
      }
      
      .calculator {
        max-width: 800px;
      }
      
      .buttons-container {
        display: flex;
      }
      
      .scientific-buttons {
        width: 50%;
        border-right: 1px solid #3a3a4e;
        border-bottom: none;
      }
      
      .basic-buttons {
        width: 50%;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      .calculator {
        max-width: 100%;
        border-radius: 20px;
      }
      
      .display {
        padding: 20px 16px;
        min-height: 160px;
      }
      
      .expression {
        font-size: 1.9rem;
      }
      
      .result {
        font-size: 1.1rem;
      }
      
      .button {
        height: 52px;
        font-size: 1.3rem;
        border-radius: 14px;
      }
      
      .scientific-btn {
        font-size: 1.1rem;
      }
      
      .scientific-buttons {
        padding: 10px;
        gap: 8px;
        max-height: 380px; /* Ajustado para móviles */
      }
      
      .basic-buttons {
        padding: 14px;
        gap: 10px;
      }
    }
    
    @media (max-width: 360px) {
      .button {
        height: 48px;
        font-size: 1.2rem;
      }
      
      .expression {
        font-size: 1.7rem;
      }
      
      .result {
        font-size: 1rem;
      }
      
      .scientific-btn {
        font-size: 1rem;
      }
      
      .scientific-buttons {
        max-height: 370px; /* Ajustado para pantallas muy pequeñas */
      }
    }
  </style>
</head>
<body>
  <!-- Calculadora con diseño nuevo -->
  <div class="calculator">
    <!-- Pantalla de resultados -->
    <div class="display">
      <div class="expression" id="expression"></div>
      <div class="result" id="result">0</div>
    </div>
    
    <!-- Botón para mostrar/ocultar funciones científicas -->
    <div class="toggle-scientific" id="toggleScientific">
      <span>Funciones científicas ︾</span>
    </div>
    
    <!-- Funciones científicas -->
    <div class="scientific-buttons collapsed" id="scientificButtons">
      <!-- Fila 1: √ π ^ ! -->
      <div class="button scientific-btn" data-action="sqrt">√</div>
      <div class="button scientific-btn" data-action="pi">π</div>
      <div class="button scientific-btn" data-action="pow">^</div>
      <div class="button scientific-btn" data-action="factorial">!</div>
      
      <!-- Fila 2: Deg sin cos tan -->
      <div class="button scientific-btn" data-action="deg" id="deg-btn">Deg</div>
      <div class="button scientific-btn" data-action="sin">sin</div>
      <div class="button scientific-btn" data-action="cos">cos</div>
      <div class="button scientific-btn" data-action="tan">tan</div>
      
      <!-- Fila 3: Inv e ln log -->
      <div class="button scientific-btn" data-action="inv" id="inv-btn">Inv</div>
      <div class="button scientific-btn" data-action="e">e</div>
      <div class="button scientific-btn" data-action="ln">ln</div>
      <div class="button scientific-btn" data-action="log">log</div>
      
      <!-- Fila 4: Interruptor de vibración (ocupa toda la fila) -->
      <div class="vibration-toggle-row">
        <label>
          <div class="toggle-switch">
            <input type="checkbox" id="vibrationToggle" checked>
            <span class="toggle-slider"></span>
          </div>
          Vibración táctil
        </label>
      </div>
    </div>
    
    <!-- Funciones básicas -->
    <div class="basic-buttons">
      <!-- Fila 4: AC () % ÷ -->
      <div class="button clear" data-action="clear">AC</div>
      <div class="button parenthesis" data-action="parenthesis">( )</div>
      <div class="button percentage" data-action="percentage">%</div>
      <div class="button operator" data-action="divide">÷</div>
      
      <!-- Fila 5: 7 8 9 × -->
      <div class="button number" data-value="7">7</div>
      <div class="button number" data-value="8">8</div>
      <div class="button number" data-value="9">9</div>
      <div class="button operator" data-action="multiply">×</div>
      
      <!-- Fila 6: 4 5 6 - -->
      <div class="button number" data-value="4">4</div>
      <div class="button number" data-value="5">5</div>
      <div class="button number" data-value="6">6</div>
      <div class="button operator" data-action="subtract">-</div>
      
      <!-- Fila 7: 1 2 3 + -->
      <div class="button number" data-value="1">1</div>
      <div class="button number" data-value="2">2</div>
      <div class="button number" data-value="3">3</div>
      <div class="button operator" data-action="add">+</div>
      
      <!-- Fila 8: 0 . ⌫ = (MODIFICADA según tus instrucciones) -->
      <div class="button number" data-value="0">0</div>
      <div class="button number" data-value=".">.</div>
      <div class="button delete" data-action="backspace">⌫</div>
      <div class="button equals" data-action="equals">=</div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar math.js para usar números grandes sin notación científica
      math.config({
        number: 'BigNumber',
        precision: 128 // Aumentar precisión para cálculos grandes
      });

      // Elementos de la calculadora
      const expressionElement = document.getElementById('expression');
      const resultElement = document.getElementById('result');
      const toggleScientificBtn = document.getElementById('toggleScientific');
      const scientificButtons = document.getElementById('scientificButtons');
      const degBtn = document.getElementById('deg-btn');
      const invBtn = document.getElementById('inv-btn');
      
      // Estado de la calculadora
      let currentExpression = '';
      let currentPreview = '0';
      let parenthesisOpen = false;
      let lastSqrtIndex = -1;
      let previewTimeout = null;
      let isDeg = true;
      let isInv = false;
      
      // ================================================
      // SISTEMA DE VIBRACIÓN SIMPLIFICADO Y ROBUSTO
      // ================================================
      
      // Estado de vibración
      let hapticFeedbackEnabled = true;
      
      // Detectar capacidades del dispositivo
      const deviceCapabilities = {
        hasVibrationAPI: ('vibrate' in navigator),
        isIOS: /iPhone|iPad|iPod/.test(navigator.userAgent),
        isAndroid: /Android/.test(navigator.userAgent),
        isChrome: /Chrome/.test(navigator.userAgent),
        isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
        isDesktop: !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
      };
      
      // Función mejorada para activar vibración
      function vibrateDevice() {
        if (!hapticFeedbackEnabled) return false;
        
        // 1. Primero intentar con la API estándar de vibración
        if (deviceCapabilities.hasVibrationAPI) {
          try {
            // Patrón de vibración corto y compatible
            const vibrationPattern = 20; // 20ms - duración óptima para todos los dispositivos
            
            // Intentar vibrar
            const result = navigator.vibrate(vibrationPattern);
            
            // Si devuelve false, significa que no está soportado
            if (result === false) {
              console.log('Vibración no soportada por el navegador');
              return false;
            }
            
            return true;
          } catch (error) {
            console.log('Error con API de vibración estándar:', error);
          }
        }
        
        // 2. Para iOS en Safari (no soporta navigator.vibrate)
        if (deviceCapabilities.isIOS && deviceCapabilities.isSafari) {
          try {
            // En iOS Safari, podemos intentar usar AudioContext como feedback háptico
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Frecuencia baja para simular vibración
            oscillator.frequency.setValueAtTime(60, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.02); // 20ms
            
            return true;
          } catch (audioError) {
            console.log('Fallback de audio para iOS falló:', audioError);
          }
        }
        
        // 3. Para dispositivos de escritorio o sin soporte de vibración
        if (deviceCapabilities.isDesktop) {
          // En desktop no hay vibración, pero podemos dar feedback visual
          try {
            // Efecto visual como alternativa
            const activeButtons = document.querySelectorAll('.button:active');
            activeButtons.forEach(button => {
              const originalColor = button.style.background;
              button.style.background = 'linear-gradient(145deg, #4cc9f0, #3aa8d8)';
              
              setTimeout(() => {
                button.style.background = originalColor;
              }, 50);
            });
            
            return true;
          } catch (visualError) {
            console.log('Fallback visual falló:', visualError);
          }
        }
        
        // 4. Si estamos en Telegram Web App, usar su API
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback) {
          try {
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
            return true;
          } catch (tgError) {
            console.log('API de Telegram falló:', tgError);
          }
        }
        
        return false;
      }
      
      // Función para formatear números grandes
      function formatLargeNumber(number) {
        try {
          // Si es un objeto BigNumber de math.js
          if (typeof number === 'object' && number.isBigNumber) {
            number = number.toString();
          }
          
          let numStr = typeof number === 'string' ? number : number.toString();
          
          // Manejar números en notación científica
          if (numStr.includes('e')) {
            try {
              const [base, exponent] = numStr.split('e');
              const exp = parseInt(exponent);
              
              if (exp >= 0) {
                const [integer, decimal = ''] = base.split('.');
                const zerosNeeded = exp - decimal.length;
                
                if (zerosNeeded >= 0) {
                  numStr = integer + decimal + '0'.repeat(zerosNeeded);
                } else {
                  const position = decimal.length + zerosNeeded;
                  numStr = integer + decimal.substring(0, position) + '.' + decimal.substring(position);
                }
              } else {
                const [integer, decimal = ''] = base.split('.');
                const allDigits = integer + decimal;
                const zerosNeeded = Math.abs(exp) - 1;
                
                numStr = '0.' + '0'.repeat(zerosNeeded) + allDigits;
              }
            } catch (e) {
              console.log('No se pudo convertir notación científica:', e);
            }
          }
          
          // Agregar separadores de miles
          const parts = numStr.split('.');
          let integerPart = parts[0];
          const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
          
          const isNegative = integerPart.startsWith('-');
          if (isNegative) integerPart = integerPart.substring(1);
          
          integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          
          if (isNegative) integerPart = '-' + integerPart;
          
          let finalDecimal = decimalPart;
          if (decimalPart.length > 10) {
            finalDecimal = decimalPart.substring(0, 11);
          }
          
          const totalLength = integerPart.length + finalDecimal.length;
          if (totalLength > 30) {
            if (integerPart.length > 20) {
              return integerPart.substring(0, 20) + '...';
            }
          }
          
          return integerPart + finalDecimal;
        } catch (error) {
          console.error('Error al formatear número:', error);
          return number.toString();
        }
      }
      
      // ================================================
      // FUNCIONES DE LA CALCULADORA
      // ================================================
      
      // Actualizar la pantalla
      function updateScreen() {
        expressionElement.textContent = currentExpression || '';
        resultElement.textContent = formatLargeNumber(currentPreview);
      }
      
      // Agregar valor a la expresión
      function addToExpression(value) {
        currentExpression += value;
        updateScreen();
        updatePreview();
      }
      
      // Actualizar previsualización en tiempo real
      function updatePreview() {
        if (previewTimeout) {
          clearTimeout(previewTimeout);
        }
        
        if (!currentExpression.trim()) {
          currentPreview = '0';
          updateScreen();
          return;
        }
        
        previewTimeout = setTimeout(() => {
          try {
            let expressionToEval = currentExpression;
            
            expressionToEval = balanceParentheses(expressionToEval);
            
            expressionToEval = expressionToEval
              .replace(/×/g, '*')
              .replace(/÷/g, '/')
              .replace(/π/g, 'pi')
              .replace(/√/g, 'sqrt')
              .replace(/\^/g, '^')
              .replace(/e/g, 'e');
            
            if (isInv) {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'asin')
                .replace(/cos/g, 'acos')
                .replace(/tan/g, 'atan');
            } else {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'sin')
                .replace(/cos/g, 'cos')
                .replace(/tan/g, 'tan');
            }
            
            if (isDeg && !isInv) {
              expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
                function(match, func, angle) {
                  return func + '(' + angle + '*pi/180)';
                });
            }
            
            expressionToEval = expressionToEval
              .replace(/ln/g, 'log')
              .replace(/log/g, 'log10');
            
            expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
              return `factorial(${num})`;
            });
            
            expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
              return `(${num}/100)`;
            });
            
            const result = math.evaluate(expressionToEval);
            
            currentPreview = result.toString();
            updateScreen();
            
          } catch (error) {
            currentPreview = '...';
            updateScreen();
          }
        }, 200);
      }
      
      // Calcular resultado final
      function calculateResult() {
        if (!currentExpression) return;
        
        try {
          let expressionToEval = currentExpression;
          
          expressionToEval = balanceParentheses(expressionToEval);
          
          expressionToEval = expressionToEval
            .replace(/×/g, '*')
            .replace(/÷/g, '/')
            .replace(/π/g, 'pi')
            .replace(/√/g, 'sqrt')
            .replace(/\^/g, '^')
            .replace(/e/g, 'e');
          
          if (isInv) {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'asin')
              .replace(/cos/g, 'acos')
              .replace(/tan/g, 'atan');
          } else {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'sin')
              .replace(/cos/g, 'cos')
              .replace(/tan/g, 'tan');
          }
          
          if (isDeg && !isInv) {
            expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
              function(match, func, angle) {
                return func + '(' + angle + '*pi/180)';
              });
          }
          
          expressionToEval = expressionToEval
            .replace(/ln/g, 'log')
            .replace(/log/g, 'log10');
          
          expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
            return `factorial(${num})`;
          });
          
          expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
            return `(${num}/100)`;
          });
          
          const result = math.evaluate(expressionToEval);
          
          let finalResult = result;
          if (isDeg && isInv) {
            finalResult = result * 180 / Math.PI;
          }
          
          let formattedResult = formatLargeNumber(finalResult);
          
          currentExpression = formattedResult;
          currentPreview = '0';
          parenthesisOpen = false;
          lastSqrtIndex = -1;
          
          updateScreen();
          
        } catch (error) {
          console.error('Error en cálculo:', error);
          currentPreview = 'Error';
          updateScreen();
          
          setTimeout(() => {
            currentPreview = '0';
            currentExpression = '';
            parenthesisOpen = false;
            lastSqrtIndex = -1;
            updateScreen();
          }, 1500);
        }
      }
      
      // Función para cerrar paréntesis automáticamente
      function balanceParentheses(expression) {
        let openCount = (expression.match(/\(/g) || []).length;
        let closeCount = (expression.match(/\)/g) || []).length;
        
        for (let i = 0; i < (openCount - closeCount); i++) {
          expression += ')';
        }
        
        return expression;
      }
      
      // Función especial para raíz cuadrada
      function handleSquareRoot() {
        if (lastSqrtIndex !== -1) {
          const afterSqrt = currentExpression.substring(lastSqrtIndex);
          if (!afterSqrt.includes(')')) {
            addToExpression(')');
            lastSqrtIndex = -1;
          }
        }
        
        addToExpression('√(');
        lastSqrtIndex = currentExpression.length - 2;
        parenthesisOpen = true;
      }
      
      // Toggle grados/radianes
      function toggleDeg() {
        isDeg = !isDeg;
        const degButtons = document.querySelectorAll('[data-action="deg"]');
        degButtons.forEach(btn => {
          btn.textContent = isDeg ? 'Deg' : 'Rad';
        });
      }
      
      // Toggle funciones inversas
      function toggleInv() {
        isInv = !isInv;
        const invButtons = document.querySelectorAll('[data-action="inv"]');
        const sinButtons = document.querySelectorAll('[data-action="sin"]');
        const cosButtons = document.querySelectorAll('[data-action="cos"]');
        const tanButtons = document.querySelectorAll('[data-action="tan"]');
        
        invButtons.forEach(btn => {
          btn.style.backgroundColor = isInv ? '#f72585' : '';
        });
        
        if (isInv) {
          sinButtons.forEach(btn => btn.textContent = 'sin⁻¹');
          cosButtons.forEach(btn => btn.textContent = 'cos⁻¹');
          tanButtons.forEach(btn => btn.textContent = 'tan⁻¹');
        } else {
          sinButtons.forEach(btn => btn.textContent = 'sin');
          cosButtons.forEach(btn => btn.textContent = 'cos');
          tanButtons.forEach(btn => btn.textContent = 'tan');
        }
      }
      
      // Manejar clics en botones CON VIBRACIÓN
      function handleButtonClick(event) {
        const button = event.target.closest('.button');
        if (!button) return;
        
        // Activar vibración si está habilitada
        vibrateDevice();
        
        // Efecto visual
        button.style.transform = 'translateY(2px) scale(0.98)';
        setTimeout(() => {
          button.style.transform = '';
        }, 150);
        
        const value = button.getAttribute('data-value');
        const action = button.getAttribute('data-action');
        
        if (value) {
          addToExpression(value);
        } else if (action) {
          switch(action) {
            case 'clear':
              clearAll();
              break;
            case 'backspace':
              backspace();
              break;
            case 'equals':
              calculateResult();
              break;
            case 'divide':
              addToExpression('÷');
              break;
            case 'multiply':
              addToExpression('×');
              break;
            case 'add':
              addToExpression('+');
              break;
            case 'subtract':
              addToExpression('-');
              break;
            case 'parenthesis':
              handleParenthesis();
              break;
            case 'percentage':
              addToExpression('%');
              break;
            case 'sqrt':
              handleSquareRoot();
              break;
            case 'pi':
              addToExpression('π');
              break;
            case 'e':
              addToExpression('e');
              break;
            case 'pow':
              addToExpression('^');
              break;
            case 'factorial':
              addToExpression('!');
              break;
            case 'sin':
              addToExpression(isInv ? 'asin(' : 'sin(');
              parenthesisOpen = true;
              break;
            case 'cos':
              addToExpression(isInv ? 'acos(' : 'cos(');
              parenthesisOpen = true;
              break;
            case 'tan':
              addToExpression(isInv ? 'atan(' : 'tan(');
              parenthesisOpen = true;
              break;
            case 'ln':
              addToExpression('ln(');
              parenthesisOpen = true;
              break;
            case 'log':
              addToExpression('log(');
              parenthesisOpen = true;
              break;
            case 'deg':
              toggleDeg();
              break;
            case 'inv':
              toggleInv();
              break;
          }
        }
      }
      
      // Limpiar todo
      function clearAll() {
        currentExpression = '';
        currentPreview = '0';
        parenthesisOpen = false;
        lastSqrtIndex = -1;
        
        if (previewTimeout) {
          clearTimeout(previewTimeout);
          previewTimeout = null;
        }
        
        updateScreen();
      }
      
      // Borrar último carácter
      function backspace() {
        if (currentExpression.slice(-2) === '√(') {
          lastSqrtIndex = -1;
        }
        
        if (currentExpression.slice(-1) === '(') {
          parenthesisOpen = false;
        } else if (currentExpression.slice(-1) === ')') {
          parenthesisOpen = true;
        }
        
        currentExpression = currentExpression.slice(0, -1);
        updateScreen();
        updatePreview();
      }
      
      // Manejar paréntesis
      function handleParenthesis() {
        if (parenthesisOpen) {
          addToExpression(')');
          parenthesisOpen = false;
        } else {
          addToExpression('(');
          parenthesisOpen = true;
        }
      }
      
      // ================================================
      // FUNCIONES DE INTERFAZ
      // ================================================
      
      // Mostrar/ocultar panel científico
      function toggleScientificPanel() {
        scientificButtons.classList.toggle('collapsed');
        
        if (scientificButtons.classList.contains('collapsed')) {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
        } else {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
        }
      }
      
      // Actualizar visibilidad del panel científico según el tamaño de pantalla
      function updateScientificPanelVisibility() {
        if (window.innerWidth >= 768) {
          scientificButtons.classList.remove('collapsed');
          toggleScientificBtn.style.display = 'none';
        } else {
          toggleScientificBtn.style.display = 'flex';
          
          if (scientificButtons.classList.contains('collapsed')) {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
          } else {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
          }
        }
      }
      
      // Manejar entrada por teclado
      function handleKeyboard(event) {
        const key = event.key;
        
        if (['+', '-', '*', '/', 'Enter', 'Escape'].includes(key)) {
          event.preventDefault();
        }
        
        if (key >= '0' && key <= '9') {
          addToExpression(key);
        } else if (key === '.') {
          addToExpression('.');
        } else if (key === '+') {
          addToExpression('+');
        } else if (key === '-') {
          addToExpression('-');
        } else if (key === '*') {
          addToExpression('×');
        } else if (key === '/') {
          addToExpression('÷');
        } else if (key === 'Enter' || key === '=') {
          calculateResult();
        } else if (key === 'Escape' || key === 'Delete') {
          clearAll();
        } else if (key === 'Backspace') {
          backspace();
        } else if (key === '(' || key === ')') {
          handleParenthesis();
        } else if (key === '%') {
          addToExpression('%');
        } else if (key === 'p' || key === 'P') {
          addToExpression('π');
        } else if (key === 'e' || key === 'E') {
          addToExpression('e');
        } else if (key === ',') {
          // Ignorar comas del teclado
          event.preventDefault();
        }
      }
      
      // ================================================
      // CONFIGURACIÓN DE VIBRACIÓN SIMPLIFICADA
      // ================================================
      
      // Cargar preferencia de vibración
      function loadVibrationPreference() {
        try {
          const savedPreference = localStorage.getItem('hapticFeedback');
          if (savedPreference !== null) {
            hapticFeedbackEnabled = savedPreference === 'true';
            document.getElementById('vibrationToggle').checked = hapticFeedbackEnabled;
          }
        } catch (error) {
          console.log('Error al cargar preferencia de vibración:', error);
        }
      }
      
      // Guardar preferencia de vibración
      function saveVibrationPreference() {
        try {
          localStorage.setItem('hapticFeedback', hapticFeedbackEnabled);
        } catch (error) {
          console.log('Error al guardar preferencia de vibración:', error);
        }
      }
      
      // Configurar interruptor de vibración
      function setupVibrationToggle() {
        const vibrationToggle = document.getElementById('vibrationToggle');
        
        vibrationToggle.addEventListener('change', function() {
          hapticFeedbackEnabled = this.checked;
          saveVibrationPreference();
          
          // Probar vibración cuando se activa
          if (hapticFeedbackEnabled) {
            setTimeout(() => vibrateDevice(), 100);
          }
        });
      }
      
      // ================================================
      // INICIALIZACIÓN
      // ================================================
      
      // Inicializar
      function initialize() {
        // Cargar preferencia de vibración
        loadVibrationPreference();
        
        // Configurar interruptor de vibración
        setupVibrationToggle();
        
        // Agregar event listeners a los botones
        document.querySelectorAll('.button').forEach(button => {
          button.addEventListener('click', handleButtonClick);
        });
        
        // Botón para mostrar/ocultar funciones científicas
        toggleScientificBtn.addEventListener('click', toggleScientificPanel);
        
        // Manejar teclado
        document.addEventListener('keydown', handleKeyboard);
        
        // Manejar cambio de tamaño de ventana
        window.addEventListener('resize', updateScientificPanelVisibility);
        
        // Inicializar visibilidad del panel
        updateScientificPanelVisibility();
        updateScreen();
        
        // Mostrar información del dispositivo
        console.log('✅ Calculadora científica inicializada');
        console.log('✅ Capacidades del dispositivo:', deviceCapabilities);
        console.log('✅ Vibración disponible:', deviceCapabilities.hasVibrationAPI);
      }
      
      // Verificar si estamos en Telegram WebApp
      const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
      
      if (isTelegramWebApp) {
        Telegram.WebApp.ready();
        console.log('✅ Calculadora Científica para Telegram inicializada');
        Telegram.WebApp.expand();
        Telegram.WebApp.setBackgroundColor('#1e1e2e');
        Telegram.WebApp.setHeaderColor('#1e1e2e');
        
        // Si estamos en Telegram, usar su API de vibración si está disponible
        if (Telegram.WebApp.HapticFeedback) {
          console.log('✅ API de vibración de Telegram disponible');
        }
      }
      
      // Inicializar la calculadora
      initialize();
    });
  </script>
</body>
</html>
