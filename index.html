<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora Científica - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1e1e2e, #2d2d44);
      color: #fff;
      padding: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    .calculator {
      width: 100%;
      max-width: 420px;
      background-color: #2a2a3e;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid #3a3a4e;
    }
    
    .display {
      background-color: #1a1a2e;
      padding: 24px 20px;
      text-align: right;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .expression {
      color: rgba(255, 255, 255, 0.95);
      font-size: 2.2rem;
      font-weight: 500;
      word-break: break-all;
      text-align: right;
      min-height: 35px;
      overflow-x: auto;
      white-space: nowrap;
      margin-bottom: 4px;
    }
    
    .result {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.3rem;
      font-weight: 400;
      word-break: break-all;
      text-align: right;
      overflow-x: auto;
      line-height: 1.3;
      min-height: 25px;
      overflow-y: auto;
      max-height: 60px;
      margin-bottom: 8px;
    }
    
    .result::-webkit-scrollbar {
      width: 4px;
    }
    
    .result::-webkit-scrollbar-track {
      background: #1a1a2e;
    }
    
    .result::-webkit-scrollbar-thumb {
      background: #4cc9f0;
      border-radius: 2px;
    }
    
    .toggle-scientific {
      display: flex;
      justify-content: center;
      padding: 10px 0;
      background: linear-gradient(to bottom, #3a3a5e, #2d2d4a);
      cursor: pointer;
      color: #a5b1c2;
      font-size: 0.9rem;
      transition: background 0.3s;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .toggle-scientific:hover {
      background: linear-gradient(to bottom, #44446e, #35355a);
    }
    
    .buttons-container {
      display: flex;
      flex-direction: column;
    }
    
    .scientific-buttons {
      background: linear-gradient(to bottom, #2d2d44, #252536);
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-height: 350px;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .scientific-buttons.collapsed {
      max-height: 0;
      padding: 0;
      border-bottom: none;
    }
    
    /* Estilo para el interruptor de vibración dentro del panel científico */
    .vibration-toggle-row {
      grid-column: 1 / -1; /* Ocupa todas las 4 columnas */
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px 0;
      margin-top: 5px;
    }
    
    .vibration-toggle-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #a5b1c2;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #2d2d4a;
      transition: .3s;
      border-radius: 20px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4cc9f0;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .basic-buttons {
      background: linear-gradient(to bottom, #252536, #1e1e2e);
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    
    .button {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 56px;
      border-radius: 16px;
      font-size: 1.4rem;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
      border: none;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      touch-action: manipulation;
    }
    
    .button:active {
      transform: translateY(2px) scale(0.98);
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
    }
    
    .scientific-btn {
      background: linear-gradient(145deg, #3a3a5e, #2d2d4a);
      font-size: 1.2rem;
    }
    
    .scientific-btn:hover {
      background: linear-gradient(145deg, #44446e, #35355a);
    }
    
    .number {
      background: linear-gradient(145deg, #2a2a3e, #1e1e2e);
    }
    
    .number:hover {
      background: linear-gradient(145deg, #34344e, #282838);
    }
    
    .operator {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .operator:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .parenthesis {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .parenthesis:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .percentage {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .percentage:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .equals {
      background: linear-gradient(145deg, #f72585, #d11475);
      color: white;
      font-weight: 600;
    }
    
    .equals:hover {
      background: linear-gradient(145deg, #ff35a5, #e12485);
    }
    
    .clear {
      background: linear-gradient(145deg, #ff6b6b, #e64c4c);
      color: white;
      font-weight: 600;
    }
    
    .clear:hover {
      background: linear-gradient(145deg, #ff7b7b, #f65c5c);
    }
    
    .delete {
      background: linear-gradient(145deg, #ff6b6b, #e64c4c);
      color: white;
      font-weight: 600;
    }
    
    .delete:hover {
      background: linear-gradient(145deg, #ff7b7b, #f65c5c);
    }
    
    @media (min-width: 768px) {
      .scientific-buttons {
        max-height: 550px !important; /* Aumentado para modo horizontal */
        padding: 15px !important;
      }
      
      .toggle-scientific {
        display: none;
      }
      
      .calculator {
        max-width: 800px;
      }
      
      .buttons-container {
        display: flex;
      }
      
      .scientific-buttons {
        width: 50%;
        border-right: 1px solid #3a3a4e;
        border-bottom: none;
      }
      
      .basic-buttons {
        width: 50%;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      .calculator {
        max-width: 100%;
        border-radius: 20px;
      }
      
      .display {
        padding: 20px 16px;
        min-height: 160px;
      }
      
      .expression {
        font-size: 1.9rem;
      }
      
      .result {
        font-size: 1.1rem;
      }
      
      .button {
        height: 52px;
        font-size: 1.3rem;
        border-radius: 14px;
      }
      
      .scientific-btn {
        font-size: 1.1rem;
      }
      
      .scientific-buttons {
        padding: 10px;
        gap: 8px;
        max-height: 380px; /* Ajustado para móviles */
      }
      
      .basic-buttons {
        padding: 14px;
        gap: 10px;
      }
    }
    
    @media (max-width: 360px) {
      .button {
        height: 48px;
        font-size: 1.2rem;
      }
      
      .expression {
        font-size: 1.7rem;
      }
      
      .result {
        font-size: 1rem;
      }
      
      .scientific-btn {
        font-size: 1rem;
      }
      
      .scientific-buttons {
        max-height: 370px; /* Ajustado para pantallas muy pequeñas */
      }
    }
    
    /* Indicador de prueba de vibración */
    .vibration-test-btn {
      background: linear-gradient(145deg, #9d4edd, #7b2cbf);
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 8px;
    }
    
    .vibration-test-btn:hover {
      background: linear-gradient(145deg, #ad5eed, #8b3ccf);
    }
    
    /* Modal de configuración de vibración */
    .vibration-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .vibration-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .vibration-modal-content {
      background: #2a2a3e;
      border-radius: 20px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid #3a3a4e;
    }
    
    .vibration-modal h3 {
      color: #4cc9f0;
      margin-bottom: 16px;
      font-size: 1.5rem;
    }
    
    .vibration-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px;
      background: #1e1e2e;
      border-radius: 12px;
      border: 1px solid #3a3a4e;
    }
    
    .vibration-option label {
      font-size: 1rem;
      color: #e0e0e0;
    }
    
    .vibration-intensity {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .intensity-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: #1e1e2e;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid #3a3a4e;
      transition: all 0.2s;
    }
    
    .intensity-btn.active {
      background: #4cc9f0;
      color: #1a1a2e;
      border-color: #4cc9f0;
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .modal-btn.primary {
      background: #4cc9f0;
      color: #1a1a2e;
    }
    
    .modal-btn.secondary {
      background: #3a3a5e;
      color: #e0e0e0;
    }
  </style>
</head>
<body>
  <!-- Calculadora con diseño nuevo -->
  <div class="calculator">
    <!-- Pantalla de resultados -->
    <div class="display">
      <div class="expression" id="expression"></div>
      <div class="result" id="result">0</div>
    </div>
    
    <!-- Botón para mostrar/ocultar funciones científicas -->
    <div class="toggle-scientific" id="toggleScientific">
      <span>Funciones científicas ︾</span>
    </div>
    
    <!-- Funciones científicas -->
    <div class="scientific-buttons collapsed" id="scientificButtons">
      <!-- Fila 1: √ π ^ ! -->
      <div class="button scientific-btn" data-action="sqrt">√</div>
      <div class="button scientific-btn" data-action="pi">π</div>
      <div class="button scientific-btn" data-action="pow">^</div>
      <div class="button scientific-btn" data-action="factorial">!</div>
      
      <!-- Fila 2: Deg sin cos tan -->
      <div class="button scientific-btn" data-action="deg" id="deg-btn">Deg</div>
      <div class="button scientific-btn" data-action="sin">sin</div>
      <div class="button scientific-btn" data-action="cos">cos</div>
      <div class="button scientific-btn" data-action="tan">tan</div>
      
      <!-- Fila 3: Inv e ln log -->
      <div class="button scientific-btn" data-action="inv" id="inv-btn">Inv</div>
      <div class="button scientific-btn" data-action="e">e</div>
      <div class="button scientific-btn" data-action="ln">ln</div>
      <div class="button scientific-btn" data-action="log">log</div>
      
      <!-- Fila 4: Interruptor de vibración (ocupa toda la fila) -->
      <div class="vibration-toggle-row">
        <label>
          <div class="toggle-switch">
            <input type="checkbox" id="vibrationToggle" checked>
            <span class="toggle-slider"></span>
          </div>
          Vibración táctil
          <div class="vibration-test-btn" id="vibrationTestBtn">Probar</div>
        </label>
      </div>
    </div>
    
    <!-- Funciones básicas -->
    <div class="basic-buttons">
      <!-- Fila 4: AC () % ÷ -->
      <div class="button clear" data-action="clear">AC</div>
      <div class="button parenthesis" data-action="parenthesis">( )</div>
      <div class="button percentage" data-action="percentage">%</div>
      <div class="button operator" data-action="divide">÷</div>
      
      <!-- Fila 5: 7 8 9 × -->
      <div class="button number" data-value="7">7</div>
      <div class="button number" data-value="8">8</div>
      <div class="button number" data-value="9">9</div>
      <div class="button operator" data-action="multiply">×</div>
      
      <!-- Fila 6: 4 5 6 - -->
      <div class="button number" data-value="4">4</div>
      <div class="button number" data-value="5">5</div>
      <div class="button number" data-value="6">6</div>
      <div class="button operator" data-action="subtract">-</div>
      
      <!-- Fila 7: 1 2 3 + -->
      <div class="button number" data-value="1">1</div>
      <div class="button number" data-value="2">2</div>
      <div class="button number" data-value="3">3</div>
      <div class="button operator" data-action="add">+</div>
      
      <!-- Fila 8: 0 . ⌫ = (MODIFICADA según tus instrucciones) -->
      <div class="button number" data-value="0">0</div>
      <div class="button number" data-value=".">.</div>
      <div class="button delete" data-action="backspace">⌫</div>
      <div class="button equals" data-action="equals">=</div>
    </div>
  </div>
  
  <!-- Modal de configuración de vibración -->
  <div class="vibration-modal" id="vibrationModal">
    <div class="vibration-modal-content">
      <h3>Configuración de Vibración</h3>
      
      <div class="vibration-option">
        <label>Activar vibración táctil</label>
        <div class="toggle-switch">
          <input type="checkbox" id="vibrationModalToggle" checked>
          <span class="toggle-slider"></span>
        </div>
      </div>
      
      <div class="vibration-option">
        <label>Intensidad de vibración</label>
      </div>
      
      <div class="vibration-intensity">
        <div class="intensity-btn active" data-intensity="light">Suave</div>
        <div class="intensity-btn" data-intensity="medium">Media</div>
        <div class="intensity-btn" data-intensity="strong">Fuerte</div>
      </div>
      
      <div class="vibration-option">
        <label>Tipo de vibración</label>
      </div>
      
      <div class="vibration-intensity">
        <div class="intensity-btn active" data-type="short">Corta</div>
        <div class="intensity-btn" data-type="medium">Media</div>
        <div class="intensity-btn" data-type="long">Larga</div>
      </div>
      
      <div class="modal-buttons">
        <div class="modal-btn secondary" id="testVibrationBtn">Probar Vibración</div>
        <div class="modal-btn primary" id="saveVibrationBtn">Guardar</div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar math.js para usar números grandes sin notación científica
      math.config({
        number: 'BigNumber',
        precision: 128 // Aumentar precisión para cálculos grandes
      });

      // Elementos de la calculadora
      const expressionElement = document.getElementById('expression');
      const resultElement = document.getElementById('result');
      const toggleScientificBtn = document.getElementById('toggleScientific');
      const scientificButtons = document.getElementById('scientificButtons');
      const degBtn = document.getElementById('deg-btn');
      const invBtn = document.getElementById('inv-btn');
      const vibrationTestBtn = document.getElementById('vibrationTestBtn');
      const vibrationModal = document.getElementById('vibrationModal');
      
      // Estado de la calculadora
      let currentExpression = '';
      let currentPreview = '0';
      let parenthesisOpen = false;
      let lastSqrtIndex = -1;
      let previewTimeout = null;
      let isDeg = true;
      let isInv = false;
      
      // ================================================
      // NUEVA FUNCIÓN PARA FORMATEAR NÚMEROS GRANDES
      // ================================================
      
      /**
       * Función para formatear números sin notación científica
       * y con separadores de miles para mejor legibilidad
       */
      function formatLargeNumber(number) {
        try {
          // Si es un objeto BigNumber de math.js
          if (typeof number === 'object' && number.isBigNumber) {
            number = number.toString();
          }
          
          // Si ya es string, convertir a número para formatear
          let numStr = typeof number === 'string' ? number : number.toString();
          
          // Manejar números en notación científica
          if (numStr.includes('e')) {
            try {
              // Convertir notación científica a número completo
              const [base, exponent] = numStr.split('e');
              const exp = parseInt(exponent);
              
              if (exp >= 0) {
                // Números positivos grandes
                const [integer, decimal = ''] = base.split('.');
                const zerosNeeded = exp - decimal.length;
                
                if (zerosNeeded >= 0) {
                  numStr = integer + decimal + '0'.repeat(zerosNeeded);
                } else {
                  const position = decimal.length + zerosNeeded;
                  numStr = integer + decimal.substring(0, position) + '.' + decimal.substring(position);
                }
              } else {
                // Números pequeños (negativos)
                const [integer, decimal = ''] = base.split('.');
                const allDigits = integer + decimal;
                const zerosNeeded = Math.abs(exp) - 1;
                
                numStr = '0.' + '0'.repeat(zerosNeeded) + allDigits;
              }
            } catch (e) {
              // Si falla, mantener la notación científica
              console.log('No se pudo convertir notación científica:', e);
            }
          }
          
          // Agregar separadores de miles
          const parts = numStr.split('.');
          let integerPart = parts[0];
          const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
          
          // Manejar números negativos
          const isNegative = integerPart.startsWith('-');
          if (isNegative) integerPart = integerPart.substring(1);
          
          // Agregar comas cada 3 dígitos
          integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          
          if (isNegative) integerPart = '-' + integerPart;
          
          // Limitar decimales a 10 para evitar overflow visual
          let finalDecimal = decimalPart;
          if (decimalPart.length > 10) {
            finalDecimal = decimalPart.substring(0, 11);
          }
          
          // Si el número es muy largo, mostrar una versión abreviada
          const totalLength = integerPart.length + finalDecimal.length;
          if (totalLength > 30) {
            if (integerPart.length > 20) {
              return integerPart.substring(0, 20) + '...';
            }
          }
          
          return integerPart + finalDecimal;
        } catch (error) {
          console.error('Error al formatear número:', error);
          return number.toString();
        }
      }
      
      // ================================================
      // FUNCIONES MODIFICADAS PARA MANEJAR NÚMEROS GRANDES
      // ================================================
      
      // Actualizar la pantalla (MODIFICADA)
      function updateScreen() {
        // Mostrar expresión con formato
        expressionElement.textContent = currentExpression || '';
        
        // Mostrar preview con formato para números grandes
        resultElement.textContent = formatLargeNumber(currentPreview);
      }
      
      // Agregar valor a la expresión (MODIFICADA)
      function addToExpression(value) {
        currentExpression += value;
        updateScreen();
        updatePreview();
      }
      
      // Actualizar previsualización en tiempo real (MODIFICADA)
      function updatePreview() {
        if (previewTimeout) {
          clearTimeout(previewTimeout);
        }
        
        if (!currentExpression.trim()) {
          currentPreview = '0';
          updateScreen();
          return;
        }
        
        previewTimeout = setTimeout(() => {
          try {
            // Preparamos la expresión para evaluación
            let expressionToEval = currentExpression;
            
            // Balancear paréntesis
            expressionToEval = balanceParentheses(expressionToEval);
            
            // Reemplazar símbolos para math.js
            expressionToEval = expressionToEval
              .replace(/×/g, '*')
              .replace(/÷/g, '/')
              .replace(/π/g, 'pi')
              .replace(/√/g, 'sqrt')
              .replace(/\^/g, '^')
              .replace(/e/g, 'e');
            
            // Manejo de funciones trigonométricas inversas
            if (isInv) {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'asin')
                .replace(/cos/g, 'acos')
                .replace(/tan/g, 'atan');
            } else {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'sin')
                .replace(/cos/g, 'cos')
                .replace(/tan/g, 'tan');
            }
            
            // Conversión grados/radianes
            if (isDeg && !isInv) {
              expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
                function(match, func, angle) {
                  return func + '(' + angle + '*pi/180)';
                });
            }
            
            // Funciones logarítmicas
            expressionToEval = expressionToEval
              .replace(/ln/g, 'log')
              .replace(/log/g, 'log10');
            
            // Factorial
            expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
              return `factorial(${num})`;
            });
            
            // Porcentaje
            expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
              return `(${num}/100)`;
            });
            
            // Evaluar con math.js usando BigNumber
            const result = math.evaluate(expressionToEval);
            
            // Formatear el resultado para mostrar
            currentPreview = result.toString();
            updateScreen();
            
          } catch (error) {
            currentPreview = '...';
            updateScreen();
          }
        }, 200);
      }
      
      // Calcular resultado final (MODIFICADA)
      function calculateResult() {
        if (!currentExpression) return;
        
        try {
          // Preparamos la expresión para evaluación
          let expressionToEval = currentExpression;
          
          // Balancear paréntesis
          expressionToEval = balanceParentheses(expressionToEval);
          
          // Reemplazar símbolos para math.js
          expressionToEval = expressionToEval
            .replace(/×/g, '*')
            .replace(/÷/g, '/')
            .replace(/π/g, 'pi')
            .replace(/√/g, 'sqrt')
            .replace(/\^/g, '^')
            .replace(/e/g, 'e');
          
          // Manejo de funciones trigonométricas inversas
          if (isInv) {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'asin')
              .replace(/cos/g, 'acos')
              .replace(/tan/g, 'atan');
          } else {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'sin')
              .replace(/cos/g, 'cos')
              .replace(/tan/g, 'tan');
          }
          
          // Conversión grados/radianes
          if (isDeg && !isInv) {
            expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
              function(match, func, angle) {
                return func + '(' + angle + '*pi/180)';
              });
          }
          
          // Funciones logarítmicas
          expressionToEval = expressionToEval
            .replace(/ln/g, 'log')
            .replace(/log/g, 'log10');
          
          // Factorial
          expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
            return `factorial(${num})`;
          });
          
          // Porcentaje
          expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
            return `(${num}/100)`;
          });
          
          // Evaluar con math.js usando BigNumber
          const result = math.evaluate(expressionToEval);
          
          let finalResult = result;
          if (isDeg && isInv) {
            finalResult = result * 180 / Math.PI;
          }
          
          // Formatear el resultado para mostrar
          let formattedResult = formatLargeNumber(finalResult);
          
          // Actualizar expresión con el resultado
          currentExpression = formattedResult;
          currentPreview = '0';
          parenthesisOpen = false;
          lastSqrtIndex = -1;
          
          updateScreen();
          
        } catch (error) {
          console.error('Error en cálculo:', error);
          currentPreview = 'Error';
          updateScreen();
          
          setTimeout(() => {
            currentPreview = '0';
            currentExpression = '';
            parenthesisOpen = false;
            lastSqrtIndex = -1;
            updateScreen();
          }, 1500);
        }
      }
      
      // ================================================
      // SISTEMA DE VIBRACIÓN MEJORADO (sin cambios)
      // ================================================
      
      // Configuración de vibración
      let vibrationConfig = {
        enabled: true,
        intensity: 'medium',
        type: 'short',
        pattern: {
          light: [15, 5, 10],
          medium: [25, 10, 15],
          strong: [40, 15, 20]
        },
        durations: {
          short: 15,
          medium: 30,
          long: 50
        }
      };
      
      // Detectar capacidades del dispositivo
      const deviceCapabilities = {
        hasVibrationAPI: ('vibrate' in navigator),
        isIOS: /iPhone|iPad|iPod/.test(navigator.userAgent),
        isAndroid: /Android/.test(navigator.userAgent),
        isChrome: /Chrome/.test(navigator.userAgent),
        isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)
      };
      
      // Función para detectar si el dispositivo soporta vibración
      function detectVibrationSupport() {
        console.log('Detectando capacidades de vibración:');
        console.log('- API de vibración disponible:', deviceCapabilities.hasVibrationAPI);
        console.log('- Sistema operativo:', deviceCapabilities.isIOS ? 'iOS' : deviceCapabilities.isAndroid ? 'Android' : 'Otro');
        console.log('- Navegador:', deviceCapabilities.isChrome ? 'Chrome' : deviceCapabilities.isSafari ? 'Safari' : 'Otro');
        
        return deviceCapabilities.hasVibrationAPI || deviceCapabilities.isIOS;
      }
      
      // Función mejorada para activar la vibración
      function vibrateDevice(forceIntensity = null, forceType = null) {
        if (!vibrationConfig.enabled) return false;
        
        const intensity = forceIntensity || vibrationConfig.intensity;
        const type = forceType || vibrationConfig.type;
        
        // Si no hay API de vibración, intentamos alternativas para iOS
        if (!deviceCapabilities.hasVibrationAPI) {
          if (deviceCapabilities.isIOS) {
            return vibrateIOSFallback(intensity, type);
          }
          return false;
        }
        
        try {
          let vibrationPattern;
          
          if (type === 'short') {
            vibrationPattern = vibrationConfig.durations[type];
          } else if (type === 'medium') {
            vibrationPattern = vibrationConfig.pattern[intensity];
          } else if (type === 'long') {
            vibrationPattern = [vibrationConfig.durations[type], 20, vibrationConfig.durations[type]/2];
          }
          
          if (deviceCapabilities.isAndroid) {
            navigator.vibrate(vibrationPattern);
          } else if (deviceCapabilities.isChrome) {
            if (navigator.vibrate(vibrationPattern) === false) {
              console.log('Vibración no soportada en este navegador');
              return false;
            }
          } else {
            navigator.vibrate(vibrationPattern);
          }
          
          return true;
        } catch (error) {
          console.error('Error al activar vibración:', error);
          
          try {
            navigator.vibrate(15);
            return true;
          } catch (e) {
            console.error('Fallback de vibración también falló:', e);
            return false;
          }
        }
      }
      
      // Fallback para iOS
      function vibrateIOSFallback(intensity, type) {
        console.log('Usando fallback para iOS');
        
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.setValueAtTime(60, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          
          const duration = vibrationConfig.durations[type] / 1000;
          
          oscillator.start();
          oscillator.stop(audioContext.currentTime + duration);
          
          return true;
        } catch (audioError) {
          console.log('Fallback de audio falló:', audioError);
        }
        
        try {
          const buttons = document.querySelectorAll('.button:active');
          buttons.forEach(button => {
            button.style.boxShadow = 'inset 0 0 10px rgba(76, 201, 240, 0.5)';
            setTimeout(() => {
              button.style.boxShadow = '';
            }, 150);
          });
          
          return true;
        } catch (visualError) {
          console.log('Fallback visual también falló:', visualError);
        }
        
        return false;
      }
      
      // Función para probar vibración
      function testVibration(intensity = null, type = null) {
        if (!vibrationConfig.enabled) {
          alert('La vibración está desactivada. Actívala primero.');
          return;
        }
        
        const success = vibrateDevice(intensity, type);
        
        if (!success) {
          console.log('No se pudo activar la vibración en este dispositivo');
          
          if (!deviceCapabilities.hasVibrationAPI) {
            alert('Tu dispositivo o navegador no soporta vibración táctil. ' +
                  'Asegúrate de usar un dispositivo móvil compatible.');
          }
        }
      }
      
      // Función para guardar configuración de vibración
      function saveVibrationConfig() {
        try {
          localStorage.setItem('vibrationConfig', JSON.stringify(vibrationConfig));
          console.log('Configuración de vibración guardada:', vibrationConfig);
          return true;
        } catch (error) {
          console.error('Error al guardar configuración:', error);
          return false;
        }
      }
      
      // Función para cargar configuración de vibración
      function loadVibrationConfig() {
        try {
          const savedConfig = localStorage.getItem('vibrationConfig');
          if (savedConfig) {
            const parsedConfig = JSON.parse(savedConfig);
            vibrationConfig = { ...vibrationConfig, ...parsedConfig };
            console.log('Configuración de vibración cargada:', vibrationConfig);
          }
        } catch (error) {
          console.error('Error al cargar configuración:', error);
        }
        
        updateVibrationUI();
      }
      
      // Actualizar controles de la UI según configuración
      function updateVibrationUI() {
        const mainToggle = document.getElementById('vibrationToggle');
        const modalToggle = document.getElementById('vibrationModalToggle');
        
        if (mainToggle) mainToggle.checked = vibrationConfig.enabled;
        if (modalToggle) modalToggle.checked = vibrationConfig.enabled;
        
        document.querySelectorAll('.intensity-btn[data-intensity]').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.intensity === vibrationConfig.intensity) {
            btn.classList.add('active');
          }
        });
        
        document.querySelectorAll('.intensity-btn[data-type]').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.type === vibrationConfig.type) {
            btn.classList.add('active');
          }
        });
      }
      
      // ================================================
      // FUNCIONES EXISTENTES (sin cambios)
      // ================================================
      
      // Función para cerrar paréntesis automáticamente
      function balanceParentheses(expression) {
        let openCount = (expression.match(/\(/g) || []).length;
        let closeCount = (expression.match(/\)/g) || []).length;
        
        for (let i = 0; i < (openCount - closeCount); i++) {
          expression += ')';
        }
        
        return expression;
      }
      
      // Función especial para raíz cuadrada
      function handleSquareRoot() {
        if (lastSqrtIndex !== -1) {
          const afterSqrt = currentExpression.substring(lastSqrtIndex);
          if (!afterSqrt.includes(')')) {
            addToExpression(')');
            lastSqrtIndex = -1;
          }
        }
        
        addToExpression('√(');
        lastSqrtIndex = currentExpression.length - 2;
        parenthesisOpen = true;
      }
      
      // Toggle grados/radianes
      function toggleDeg() {
        isDeg = !isDeg;
        const degButtons = document.querySelectorAll('[data-action="deg"]');
        degButtons.forEach(btn => {
          btn.textContent = isDeg ? 'Deg' : 'Rad';
        });
      }
      
      // Toggle funciones inversas
      function toggleInv() {
        isInv = !isInv;
        const invButtons = document.querySelectorAll('[data-action="inv"]');
        const sinButtons = document.querySelectorAll('[data-action="sin"]');
        const cosButtons = document.querySelectorAll('[data-action="cos"]');
        const tanButtons = document.querySelectorAll('[data-action="tan"]');
        
        invButtons.forEach(btn => {
          btn.style.backgroundColor = isInv ? '#f72585' : '';
        });
        
        if (isInv) {
          sinButtons.forEach(btn => btn.textContent = 'sin⁻¹');
          cosButtons.forEach(btn => btn.textContent = 'cos⁻¹');
          tanButtons.forEach(btn => btn.textContent = 'tan⁻¹');
        } else {
          sinButtons.forEach(btn => btn.textContent = 'sin');
          cosButtons.forEach(btn => btn.textContent = 'cos');
          tanButtons.forEach(btn => btn.textContent = 'tan');
        }
      }
      
      // Manejar clics en botones
      function handleButtonClick(event) {
        const button = event.target.closest('.button');
        if (!button) return;
        
        // Vibración
        if (vibrationConfig.enabled) {
          const action = button.getAttribute('data-action');
          const value = button.getAttribute('data-value');
          
          let vibrationType = 'short';
          let vibrationIntensity = 'medium';
          
          if (action === 'equals') {
            vibrationType = 'medium';
            vibrationIntensity = 'strong';
          } else if (action === 'clear' || action === 'backspace') {
            vibrationType = 'short';
            vibrationIntensity = 'light';
          } else if (button.classList.contains('operator')) {
            vibrationType = 'short';
            vibrationIntensity = 'medium';
          } else if (button.classList.contains('scientific-btn')) {
            vibrationType = 'short';
            vibrationIntensity = 'light';
          }
          
          vibrateDevice(vibrationIntensity, vibrationType);
        }
        
        // Efecto visual
        button.style.transform = 'translateY(2px) scale(0.98)';
        setTimeout(() => {
          button.style.transform = '';
        }, 150);
        
        const value = button.getAttribute('data-value');
        const action = button.getAttribute('data-action');
        
        if (value) {
          addToExpression(value);
        } else if (action) {
          switch(action) {
            case 'clear':
              clearAll();
              break;
            case 'backspace':
              backspace();
              break;
            case 'equals':
              calculateResult();
              break;
            case 'divide':
              addToExpression('÷');
              break;
            case 'multiply':
              addToExpression('×');
              break;
            case 'add':
              addToExpression('+');
              break;
            case 'subtract':
              addToExpression('-');
              break;
            case 'parenthesis':
              handleParenthesis();
              break;
            case 'percentage':
              addToExpression('%');
              break;
            case 'sqrt':
              handleSquareRoot();
              break;
            case 'pi':
              addToExpression('π');
              break;
            case 'e':
              addToExpression('e');
              break;
            case 'pow':
              addToExpression('^');
              break;
            case 'factorial':
              addToExpression('!');
              break;
            case 'sin':
              addToExpression(isInv ? 'asin(' : 'sin(');
              parenthesisOpen = true;
              break;
            case 'cos':
              addToExpression(isInv ? 'acos(' : 'cos(');
              parenthesisOpen = true;
              break;
            case 'tan':
              addToExpression(isInv ? 'atan(' : 'tan(');
              parenthesisOpen = true;
              break;
            case 'ln':
              addToExpression('ln(');
              parenthesisOpen = true;
              break;
            case 'log':
              addToExpression('log(');
              parenthesisOpen = true;
              break;
            case 'deg':
              toggleDeg();
              break;
            case 'inv':
              toggleInv();
              break;
          }
        }
      }
      
      // Limpiar todo
      function clearAll() {
        currentExpression = '';
        currentPreview = '0';
        parenthesisOpen = false;
        lastSqrtIndex = -1;
        
        if (previewTimeout) {
          clearTimeout(previewTimeout);
          previewTimeout = null;
        }
        
        updateScreen();
      }
      
      // Borrar último carácter
      function backspace() {
        if (currentExpression.slice(-2) === '√(') {
          lastSqrtIndex = -1;
        }
        
        if (currentExpression.slice(-1) === '(') {
          parenthesisOpen = false;
        } else if (currentExpression.slice(-1) === ')') {
          parenthesisOpen = true;
        }
        
        currentExpression = currentExpression.slice(0, -1);
        updateScreen();
        updatePreview();
      }
      
      // Manejar paréntesis
      function handleParenthesis() {
        if (parenthesisOpen) {
          addToExpression(')');
          parenthesisOpen = false;
        } else {
          addToExpression('(');
          parenthesisOpen = true;
        }
      }
      
      // ================================================
      // FUNCIONES DE INTERFAZ (sin cambios)
      // ================================================
      
      // Mostrar/ocultar panel científico
      function toggleScientificPanel() {
        scientificButtons.classList.toggle('collapsed');
        
        if (scientificButtons.classList.contains('collapsed')) {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
        } else {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
        }
      }
      
      // Actualizar visibilidad del panel científico según el tamaño de pantalla
      function updateScientificPanelVisibility() {
        if (window.innerWidth >= 768) {
          scientificButtons.classList.remove('collapsed');
          toggleScientificBtn.style.display = 'none';
        } else {
          toggleScientificBtn.style.display = 'flex';
          
          if (scientificButtons.classList.contains('collapsed')) {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
          } else {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
          }
        }
      }
      
      // Mostrar modal de configuración de vibración
      function showVibrationModal() {
        vibrationModal.classList.add('active');
      }
      
      // Ocultar modal de configuración de vibración
      function hideVibrationModal() {
        vibrationModal.classList.remove('active');
      }
      
      // Manejar entrada por teclado
      function handleKeyboard(event) {
        const key = event.key;
        
        if (['+', '-', '*', '/', 'Enter', 'Escape'].includes(key)) {
          event.preventDefault();
        }
        
        if (key >= '0' && key <= '9') {
          addToExpression(key);
        } else if (key === '.') {
          addToExpression('.');
        } else if (key === '+') {
          addToExpression('+');
        } else if (key === '-') {
          addToExpression('-');
        } else if (key === '*') {
          addToExpression('×');
        } else if (key === '/') {
          addToExpression('÷');
        } else if (key === 'Enter' || key === '=') {
          calculateResult();
        } else if (key === 'Escape' || key === 'Delete') {
          clearAll();
        } else if (key === 'Backspace') {
          backspace();
        } else if (key === '(' || key === ')') {
          handleParenthesis();
        } else if (key === '%') {
          addToExpression('%');
        } else if (key === 'p' || key === 'P') {
          addToExpression('π');
        } else if (key === 'e' || key === 'E') {
          addToExpression('e');
        } else if (key === ',') {
          // Ignorar comas del teclado
          event.preventDefault();
        }
      }
      
      // ================================================
      // CONFIGURACIÓN DEL SISTEMA DE VIBRACIÓN
      // ================================================
      
      // Configurar eventos del modal de vibración
      function setupVibrationModalEvents() {
        vibrationTestBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          showVibrationModal();
        });
        
        document.getElementById('testVibrationBtn').addEventListener('click', function() {
          testVibration();
        });
        
        document.getElementById('saveVibrationBtn').addEventListener('click', function() {
          vibrationConfig.enabled = document.getElementById('vibrationModalToggle').checked;
          
          const intensityBtn = document.querySelector('.intensity-btn[data-intensity].active');
          if (intensityBtn) {
            vibrationConfig.intensity = intensityBtn.dataset.intensity;
          }
          
          const typeBtn = document.querySelector('.intensity-btn[data-type].active');
          if (typeBtn) {
            vibrationConfig.type = typeBtn.dataset.type;
          }
          
          saveVibrationConfig();
          
          document.getElementById('vibrationToggle').checked = vibrationConfig.enabled;
          
          hideVibrationModal();
          
          if (vibrationConfig.enabled) {
            testVibration();
          }
        });
        
        document.querySelectorAll('.intensity-btn[data-intensity]').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.intensity-btn[data-intensity]').forEach(b => {
              b.classList.remove('active');
            });
            this.classList.add('active');
          });
        });
        
        document.querySelectorAll('.intensity-btn[data-type]').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.intensity-btn[data-type]').forEach(b => {
              b.classList.remove('active');
            });
            this.classList.add('active');
          });
        });
        
        vibrationModal.addEventListener('click', function(e) {
          if (e.target === vibrationModal) {
            hideVibrationModal();
          }
        });
      }
      
      // Configurar interruptor de vibración principal
      function setupVibrationToggle() {
        const vibrationToggle = document.getElementById('vibrationToggle');
        
        vibrationToggle.addEventListener('change', function() {
          vibrationConfig.enabled = this.checked;
          saveVibrationConfig();
          
          if (vibrationConfig.enabled) {
            testVibration();
          }
        });
      }
      
      // ================================================
      // INICIALIZACIÓN
      // ================================================
      
      // Inicializar
      function initialize() {
        // Detectar capacidades del dispositivo
        detectVibrationSupport();
        
        // Cargar configuración de vibración
        loadVibrationConfig();
        
        // Configurar eventos de vibración
        setupVibrationToggle();
        setupVibrationModalEvents();
        
        // Agregar event listeners a los botones
        document.querySelectorAll('.button').forEach(button => {
          button.addEventListener('click', handleButtonClick);
        });
        
        // Botón para mostrar/ocultar funciones científicas
        toggleScientificBtn.addEventListener('click', toggleScientificPanel);
        
        // Manejar teclado
        document.addEventListener('keydown', handleKeyboard);
        
        // Manejar cambio de tamaño de ventana
        window.addEventListener('resize', updateScientificPanelVisibility);
        
        // Inicializar visibilidad del panel
        updateScientificPanelVisibility();
        updateScreen();
        
        // Mostrar información al iniciar
        console.log('✅ Calculadora científica inicializada');
        console.log('✅ Sistema de números grandes configurado');
        
        // Probar vibración al inicio si está activada
        if (vibrationConfig.enabled) {
          setTimeout(() => {
            testVibration('light', 'short');
          }, 500);
        }
      }
      
      // Verificar si estamos en Telegram WebApp
      const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
      
      if (isTelegramWebApp) {
        Telegram.WebApp.ready();
        console.log('✅ Calculadora Científica para Telegram inicializada');
        Telegram.WebApp.expand();
        Telegram.WebApp.setBackgroundColor('#1e1e2e');
        Telegram.WebApp.setHeaderColor('#1e1e2e');
      }
      
      // Inicializar la calculadora
      initialize();
    });
  </script>
</body>
</html>
