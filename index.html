<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora Científica - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1e1e2e, #2d2d44);
      color: #fff;
      padding: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    .calculator {
      width: 100%;
      max-width: 420px;
      background-color: #2a2a3e;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid #3a3a4e;
    }
    
    .display {
      background-color: #1a1a2e;
      padding: 24px 20px;
      text-align: right;
      min-height: 180px; /* Aumentado de 160px a 180px */
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .expression {
      color: rgba(255, 255, 255, 0.95); /* Más visible */
      font-size: 2.2rem; /* Reducido de 1.5rem a 2.2rem */
      font-weight: 500;
      word-break: break-all;
      text-align: right;
      min-height: 35px;
      overflow-x: auto;
      white-space: nowrap;
      margin-bottom: 4px; /* Reducido espacio */
    }
    
    .result {
      color: rgba(255, 255, 255, 0.7); /* Menos prominente */
      font-size: 1.3rem; /* Reducido de 3.5rem a 1.3rem */
      font-weight: 400; /* Más ligero */
      word-break: break-all;
      text-align: right;
      overflow-x: auto;
      line-height: 1.3;
      min-height: 25px; /* Reducido altura */
      overflow-y: auto;
      max-height: 60px; /* Reducido altura máxima */
      margin-bottom: 8px; /* Espacio adicional */
    }
    
    .result::-webkit-scrollbar {
      width: 4px;
    }
    
    .result::-webkit-scrollbar-track {
      background: #1a1a2e;
    }
    
    .result::-webkit-scrollbar-thumb {
      background: #4cc9f0;
      border-radius: 2px;
    }
    
    .toggle-scientific {
      display: flex;
      justify-content: center;
      padding: 10px 0;
      background: linear-gradient(to bottom, #3a3a5e, #2d2d4a);
      cursor: pointer;
      color: #a5b1c2;
      font-size: 0.9rem;
      transition: background 0.3s;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .toggle-scientific:hover {
      background: linear-gradient(to bottom, #44446e, #35355a);
    }
    
    .buttons-container {
      display: flex;
      flex-direction: column;
    }
    
    .scientific-buttons {
      background: linear-gradient(to bottom, #2d2d44, #252536);
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-height: 300px;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      border-bottom: 1px solid #3a3a4e;
    }
    
    .scientific-buttons.collapsed {
      max-height: 0;
      padding: 0;
      border-bottom: none;
    }
    
    .basic-buttons {
      background: linear-gradient(to bottom, #252536, #1e1e2e);
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    
    .button {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 56px;
      border-radius: 16px;
      font-size: 1.4rem;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
      border: none;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      touch-action: manipulation;
    }
    
    .button:active {
      transform: translateY(2px) scale(0.98);
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
    }
    
    .scientific-btn {
      background: linear-gradient(145deg, #3a3a5e, #2d2d4a);
      font-size: 1.2rem;
    }
    
    .scientific-btn:hover {
      background: linear-gradient(145deg, #44446e, #35355a);
    }
    
    .number {
      background: linear-gradient(145deg, #2a2a3e, #1e1e2e);
    }
    
    .number:hover {
      background: linear-gradient(145deg, #34344e, #282838);
    }
    
    .operator {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .operator:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .parenthesis {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .parenthesis:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    /* MODIFICACIÓN: Botón de porcentaje con color de operador */
    .percentage {
      background: linear-gradient(145deg, #4cc9f0, #3aa8d8);
      color: #1a1a2e;
      font-weight: 600;
    }
    
    .percentage:hover {
      background: linear-gradient(145deg, #5cd9ff, #4ab8e8);
    }
    
    .equals {
      background: linear-gradient(145deg, #f72585, #d11475);
      color: white;
      font-weight: 600;
    }
    
    .equals:hover {
      background: linear-gradient(145deg, #ff35a5, #e12485);
    }
    
    .clear {
      background: linear-gradient(145deg, #ff6b6b, #e64c4c);
      color: white;
      font-weight: 600;
    }
    
    .clear:hover {
      background: linear-gradient(145deg, #ff7b7b, #f65c5c);
    }
    
    .delete {
      background: linear-gradient(145deg, #ff6b6b, #e64c4c);
      color: white;
      font-weight: 600;
    }
    
    .delete:hover {
      background: linear-gradient(145deg, #ff7b7b, #f65c5c);
    }
    
    /* Modo horizontal (pantallas más anchas) */
    @media (min-width: 768px) {
      .scientific-buttons {
        max-height: 500px !important;
        padding: 15px !important;
      }
      
      .toggle-scientific {
        display: none;
      }
      
      .calculator {
        max-width: 800px;
      }
      
      .buttons-container {
        display: flex;
      }
      
      .scientific-buttons {
        width: 50%;
        border-right: 1px solid #3a3a4e;
        border-bottom: none;
      }
      
      .basic-buttons {
        width: 50%;
      }
    }
    
    /* Para pantallas pequeñas */
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      .calculator {
        max-width: 100%;
        border-radius: 20px;
      }
      
      .display {
        padding: 20px 16px;
        min-height: 160px; /* Aumentado de 140px a 160px */
      }
      
      .expression {
        font-size: 1.9rem; /* Ajustado de 1.3rem a 1.9rem */
      }
      
      .result {
        font-size: 1.1rem; /* Ajustado de 3rem a 1.1rem */
      }
      
      .button {
        height: 52px;
        font-size: 1.3rem;
        border-radius: 14px;
      }
      
      .scientific-btn {
        font-size: 1.1rem;
      }
      
      .scientific-buttons {
        padding: 10px;
        gap: 8px;
      }
      
      .basic-buttons {
        padding: 14px;
        gap: 10px;
      }
    }
    
    /* Para pantallas muy pequeñas */
    @media (max-width: 360px) {
      .button {
        height: 48px;
        font-size: 1.2rem;
      }
      
      .expression {
        font-size: 1.7rem; /* Ajustado de 1.2rem a 1.7rem */
      }
      
      .result {
        font-size: 1rem; /* Ajustado de 2.5rem a 1rem */
      }
      
      .scientific-btn {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Calculadora con diseño nuevo -->
  <div class="calculator">
    <!-- Pantalla de resultados -->
    <div class="display">
      <div class="expression" id="expression"></div>
      <div class="result" id="result">0</div>
    </div>
    
    <!-- Botón para mostrar/ocultar funciones científicas -->
    <div class="toggle-scientific" id="toggleScientific">
      <span>Funciones científicas ︾</span>
    </div>
    
    <!-- Funciones científicas -->
    <div class="scientific-buttons collapsed" id="scientificButtons">
      <!-- Fila 1: √ π ^ ! -->
      <div class="button scientific-btn" data-action="sqrt">√</div>
      <div class="button scientific-btn" data-action="pi">π</div>
      <div class="button scientific-btn" data-action="pow">^</div>
      <div class="button scientific-btn" data-action="factorial">!</div>
      
      <!-- Fila 2: Deg sin cos tan -->
      <div class="button scientific-btn" data-action="deg" id="deg-btn">Deg</div>
      <div class="button scientific-btn" data-action="sin">sin</div>
      <div class="button scientific-btn" data-action="cos">cos</div>
      <div class="button scientific-btn" data-action="tan">tan</div>
      
      <!-- Fila 3: Inv e ln log -->
      <div class="button scientific-btn" data-action="inv" id="inv-btn">Inv</div>
      <div class="button scientific-btn" data-action="e">e</div>
      <div class="button scientific-btn" data-action="ln">ln</div>
      <div class="button scientific-btn" data-action="log">log</div>
    </div>
    
    <!-- Funciones básicas -->
    <div class="basic-buttons">
      <!-- Fila 4: AC () % ÷ -->
      <div class="button clear" data-action="clear">AC</div>
      <div class="button parenthesis" data-action="parenthesis">( )</div>
      <div class="button percentage" data-action="percentage">%</div>
      <div class="button operator" data-action="divide">÷</div>
      
      <!-- Fila 5: 7 8 9 × -->
      <div class="button number" data-value="7">7</div>
      <div class="button number" data-value="8">8</div>
      <div class="button number" data-value="9">9</div>
      <div class="button operator" data-action="multiply">×</div>
      
      <!-- Fila 6: 4 5 6 - -->
      <div class="button number" data-value="4">4</div>
      <div class="button number" data-value="5">5</div>
      <div class="button number" data-value="6">6</div>
      <div class="button operator" data-action="subtract">-</div>
      
      <!-- Fila 7: 1 2 3 + -->
      <div class="button number" data-value="1">1</div>
      <div class="button number" data-value="2">2</div>
      <div class="button number" data-value="3">3</div>
      <div class="button operator" data-action="add">+</div>
      
      <!-- Fila 8: 0 . ⌫ = (MODIFICADA según tus instrucciones) -->
      <div class="button number" data-value="0">0</div>
      <div class="button number" data-value=".">.</div>
      <div class="button delete" data-action="backspace">⌫</div>
      <div class="button equals" data-action="equals">=</div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elementos de la calculadora
      const expressionElement = document.getElementById('expression');
      const resultElement = document.getElementById('result');
      const toggleScientificBtn = document.getElementById('toggleScientific');
      const scientificButtons = document.getElementById('scientificButtons');
      const degBtn = document.getElementById('deg-btn');
      const invBtn = document.getElementById('inv-btn');
      
      // Estado de la calculadora
      let currentExpression = '';
      let currentPreview = '0';
      let parenthesisOpen = false;
      let lastSqrtIndex = -1;
      let previewTimeout = null;
      let isDeg = true;
      let isInv = false;
      
      // ================================================
      // NUEVAS FUNCIONES PARA FORMATO DE NÚMEROS
      // ================================================
      
      /**
       * Función para formatear números con separadores de miles
       * Ejemplo: 1000000 -> "1,000,000"
       */
      function formatNumberWithCommas(numStr) {
        // Si es un número en notación científica, lo convertimos primero
        if (numStr.includes('e')) {
          try {
            // Convertimos la notación científica a número completo
            const num = parseFloat(numStr);
            if (isNaN(num)) return numStr;
            
            // Si el número es muy grande o muy pequeño, lo manejamos de forma especial
            if (Math.abs(num) > 1e15 || (Math.abs(num) < 1e-6 && num !== 0)) {
              // Para números extremadamente grandes/pequeños, mantenemos notación científica
              // pero la formateamos mejor
              return num.toExponential(10).replace(/(\.\d*?)(0+)e/, '$1e').replace(/\.e/, 'e');
            }
            
            numStr = num.toString();
          } catch (e) {
            return numStr;
          }
        }
        
        // Separamos parte entera y decimal
        const parts = numStr.split('.');
        let integerPart = parts[0];
        const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
        
        // Añadimos comas cada 3 dígitos en la parte entera
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        return integerPart + decimalPart;
      }
      
      /**
       * Función para formatear una expresión matemática manteniendo los números con comas
       * pero sin afectar a las funciones matemáticas
       */
      function formatExpressionWithCommas(expression) {
        if (!expression) return '';
        
        // Reemplazamos números en la expresión (excluyendo funciones como sin, cos, etc.)
        return expression.replace(/(\d+(?:\.\d+)?)/g, function(match) {
          return formatNumberWithCommas(match);
        });
      }
      
      /**
       * Función para eliminar comas de un número formateado antes de realizar cálculos
       */
      function removeCommas(numStr) {
        return numStr.replace(/,/g, '');
      }
      
      /**
       * Función para manejar números grandes sin notación científica
       * Mantiene el número como string para evitar pérdida de precisión
       */
      function handleLargeNumber(result) {
        try {
          // Si el resultado es un número muy grande, lo mantenemos como string
          if (typeof result === 'number' && (Math.abs(result) > 1e15 || 
              (Math.abs(result) < 1e-6 && result !== 0))) {
            // Para números extremadamente grandes, usamos notación de cadena
            if (Math.abs(result) >= 1e21) {
              return result.toExponential(10);
            }
            // Para números grandes pero manejables, intentamos string normal
            const str = result.toString();
            // Si aún está en notación científica, la convertimos
            if (str.includes('e')) {
              return result.toLocaleString('fullwide', { useGrouping: false });
            }
            return str;
          }
          
          // Para números normales, los convertimos a string
          let str = result.toString();
          
          // Si aparece notación científica, la manejamos
          if (str.includes('e')) {
            // Intentamos convertir a número completo
            try {
              // Usamos toLocaleString para evitar notación científica
              str = result.toLocaleString('fullwide', { useGrouping: false });
            } catch (e) {
              // Si falla, mantenemos la notación científica pero la formateamos
              str = result.toExponential(10)
                .replace(/(\.\d*?)(0+)e/, '$1e')
                .replace(/\.e/, 'e');
            }
          }
          
          return str;
        } catch (e) {
          return result.toString();
        }
      }
      
      // ================================================
      // FUNCIONES MODIFICADAS DE LA CALCULADORA
      // ================================================
      
      // Actualizar la pantalla (MODIFICADA)
      function updateScreen() {
        // Mostramos la expresión con comas para mejor legibilidad
        expressionElement.textContent = formatExpressionWithCommas(currentExpression) || '';
        
        // Mostramos el preview con comas
        resultElement.textContent = formatNumberWithCommas(currentPreview);
      }
      
      // Agregar valor a la expresión (MODIFICADA)
      function addToExpression(value) {
        // Si el valor es un número o punto decimal, lo añadimos directamente
        if (value.match(/[\d\.]/)) {
          currentExpression += value;
        } else {
          // Para operadores y funciones, aseguramos que el último número no tenga comas
          const cleanExpression = removeCommas(currentExpression);
          currentExpression = cleanExpression + value;
        }
        updateScreen();
        updatePreview();
      }
      
      // Borrar último carácter (MODIFICADA)
      function backspace() {
        if (currentExpression.slice(-2) === '√(') {
          lastSqrtIndex = -1;
        }
        
        if (currentExpression.slice(-1) === '(') {
          parenthesisOpen = false;
        } else if (currentExpression.slice(-1) === ')') {
          parenthesisOpen = true;
        }
        
        // Eliminamos el último carácter de la expresión sin comas
        const cleanExpression = removeCommas(currentExpression);
        currentExpression = cleanExpression.slice(0, -1);
        updateScreen();
        updatePreview();
      }
      
      // Actualizar previsualización en tiempo real (MODIFICADA)
      function updatePreview() {
        if (previewTimeout) {
          clearTimeout(previewTimeout);
        }
        
        if (!currentExpression.trim()) {
          currentPreview = '0';
          updateScreen();
          return;
        }
        
        previewTimeout = setTimeout(() => {
          try {
            // Preparamos la expresión para evaluación (sin comas)
            let expressionToEval = removeCommas(currentExpression);
            
            // Balanceamos paréntesis
            expressionToEval = balanceParentheses(expressionToEval);
            
            // Reemplazamos símbolos para math.js
            expressionToEval = expressionToEval
              .replace(/×/g, '*')
              .replace(/÷/g, '/')
              .replace(/π/g, 'pi')
              .replace(/√/g, 'sqrt')
              .replace(/\^/g, '^')
              .replace(/e/g, 'e');
            
            // Manejo de funciones trigonométricas inversas
            if (isInv) {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'asin')
                .replace(/cos/g, 'acos')
                .replace(/tan/g, 'atan');
            } else {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'sin')
                .replace(/cos/g, 'cos')
                .replace(/tan/g, 'tan');
            }
            
            // Conversión grados/radianes
            if (isDeg && !isInv) {
              expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
                function(match, func, angle) {
                  return func + '(' + angle + '*pi/180)';
                });
            }
            
            // Funciones logarítmicas
            expressionToEval = expressionToEval
              .replace(/ln/g, 'log')
              .replace(/log/g, 'log10');
            
            // Factorial
            expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
              return `factorial(${num})`;
            });
            
            // Porcentaje
            expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
              return `(${num}/100)`;
            });
            
            // Evaluamos la expresión
            const result = math.evaluate(expressionToEval);
            
            // Formateamos el resultado para evitar notación científica
            let formattedResult = handleLargeNumber(result);
            
            // Limitamos la longitud para pantalla
            if (formattedResult.length > 20) {
              // Si es un número entero muy largo, lo truncamos pero mantenemos como string
              if (!formattedResult.includes('.') && !formattedResult.includes('e')) {
                if (formattedResult.length > 30) {
                  formattedResult = formattedResult.substring(0, 30) + '...';
                }
              } else if (formattedResult.includes('.')) {
                // Para decimales, limitamos los dígitos decimales
                const [integer, decimal] = formattedResult.split('.');
                if (integer.length > 15) {
                  formattedResult = integer.substring(0, 15) + '...';
                } else if (decimal && decimal.length > 10) {
                  formattedResult = integer + '.' + decimal.substring(0, 10);
                }
              }
            }
            
            currentPreview = formattedResult;
            updateScreen();
            
          } catch (error) {
            currentPreview = '...';
            updateScreen();
          }
        }, 200);
      }
      
      // Calcular resultado final (MODIFICADA)
      function calculateResult() {
        if (!currentExpression) return;
        
        try {
          // Preparamos la expresión para evaluación (sin comas)
          let expressionToEval = removeCommas(currentExpression);
          
          // Balanceamos paréntesis
          expressionToEval = balanceParentheses(expressionToEval);
          
          // Reemplazamos símbolos para math.js
          expressionToEval = expressionToEval
            .replace(/×/g, '*')
            .replace(/÷/g, '/')
            .replace(/π/g, 'pi')
            .replace(/√/g, 'sqrt')
            .replace(/\^/g, '^')
            .replace(/e/g, 'e');
          
          // Manejo de funciones trigonométricas inversas
          if (isInv) {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'asin')
              .replace(/cos/g, 'acos')
              .replace(/tan/g, 'atan');
          } else {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'sin')
              .replace(/cos/g, 'cos')
              .replace(/tan/g, 'tan');
          }
          
          // Conversión grados/radianes
          if (isDeg && !isInv) {
            expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
              function(match, func, angle) {
                return func + '(' + angle + '*pi/180)';
              });
          }
          
          // Funciones logarítmicas
          expressionToEval = expressionToEval
            .replace(/ln/g, 'log')
            .replace(/log/g, 'log10');
          
          // Factorial
          expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
            return `factorial(${num})`;
          });
          
          // Porcentaje
          expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
            return `(${num}/100)`;
          });
          
          // Evaluamos
          const result = math.evaluate(expressionToEval);
          
          let finalResult = result;
          if (isDeg && isInv) {
            finalResult = result * 180 / Math.PI;
          }
          
          // Formateamos el resultado final
          let formattedResult = handleLargeNumber(finalResult);
          
          // Actualizamos la expresión con el resultado (sin comas para futuros cálculos)
          currentExpression = removeCommas(formattedResult);
          currentPreview = '0';
          parenthesisOpen = false;
          lastSqrtIndex = -1;
          
          updateScreen();
          
        } catch (error) {
          console.error('Error en cálculo:', error);
          currentPreview = 'Error';
          updateScreen();
          
          setTimeout(() => {
            currentPreview = '0';
            currentExpression = '';
            parenthesisOpen = false;
            lastSqrtIndex = -1;
            updateScreen();
          }, 1500);
        }
      }
      
      // ================================================
      // FUNCIONES EXISTENTES (sin cambios)
      // ================================================
      
      // Función para cerrar paréntesis automáticamente
      function balanceParentheses(expression) {
        let openCount = (expression.match(/\(/g) || []).length;
        let closeCount = (expression.match(/\)/g) || []).length;
        
        for (let i = 0; i < (openCount - closeCount); i++) {
          expression += ')';
        }
        
        return expression;
      }
      
      // Función especial para raíz cuadrada
      function handleSquareRoot() {
        if (lastSqrtIndex !== -1) {
          const afterSqrt = currentExpression.substring(lastSqrtIndex);
          if (!afterSqrt.includes(')')) {
            addToExpression(')');
            lastSqrtIndex = -1;
          }
        }
        
        addToExpression('√(');
        lastSqrtIndex = currentExpression.length - 2;
        parenthesisOpen = true;
      }
      
      // Toggle grados/radianes
      function toggleDeg() {
        isDeg = !isDeg;
        const degButtons = document.querySelectorAll('[data-action="deg"]');
        degButtons.forEach(btn => {
          btn.textContent = isDeg ? 'Deg' : 'Rad';
        });
      }
      
      // Toggle funciones inversas
      function toggleInv() {
        isInv = !isInv;
        const invButtons = document.querySelectorAll('[data-action="inv"]');
        const sinButtons = document.querySelectorAll('[data-action="sin"]');
        const cosButtons = document.querySelectorAll('[data-action="cos"]');
        const tanButtons = document.querySelectorAll('[data-action="tan"]');
        
        invButtons.forEach(btn => {
          btn.style.backgroundColor = isInv ? '#f72585' : '';
        });
        
        if (isInv) {
          sinButtons.forEach(btn => btn.textContent = 'sin⁻¹');
          cosButtons.forEach(btn => btn.textContent = 'cos⁻¹');
          tanButtons.forEach(btn => btn.textContent = 'tan⁻¹');
        } else {
          sinButtons.forEach(btn => btn.textContent = 'sin');
          cosButtons.forEach(btn => btn.textContent = 'cos');
          tanButtons.forEach(btn => btn.textContent = 'tan');
        }
      }
      
      // Manejar clics en botones
      function handleButtonClick(event) {
        const button = event.target.closest('.button');
        if (!button) return;
        
        button.style.transform = 'translateY(2px) scale(0.98)';
        setTimeout(() => {
          button.style.transform = '';
        }, 150);
        
        const value = button.getAttribute('data-value');
        const action = button.getAttribute('data-action');
        
        if (value) {
          addToExpression(value);
        } else if (action) {
          switch(action) {
            case 'clear':
              clearAll();
              break;
            case 'backspace':
              backspace();
              break;
            case 'equals':
              calculateResult();
              break;
            case 'divide':
              addToExpression('÷');
              break;
            case 'multiply':
              addToExpression('×');
              break;
            case 'add':
              addToExpression('+');
              break;
            case 'subtract':
              addToExpression('-');
              break;
            case 'parenthesis':
              handleParenthesis();
              break;
            case 'percentage':
              addToExpression('%');
              break;
            case 'sqrt':
              handleSquareRoot();
              break;
            case 'pi':
              addToExpression('π');
              break;
            case 'e':
              addToExpression('e');
              break;
            case 'pow':
              addToExpression('^');
              break;
            case 'factorial':
              addToExpression('!');
              break;
            case 'sin':
              addToExpression(isInv ? 'asin(' : 'sin(');
              parenthesisOpen = true;
              break;
            case 'cos':
              addToExpression(isInv ? 'acos(' : 'cos(');
              parenthesisOpen = true;
              break;
            case 'tan':
              addToExpression(isInv ? 'atan(' : 'tan(');
              parenthesisOpen = true;
              break;
            case 'ln':
              addToExpression('ln(');
              parenthesisOpen = true;
              break;
            case 'log':
              addToExpression('log(');
              parenthesisOpen = true;
              break;
            case 'deg':
              toggleDeg();
              break;
            case 'inv':
              toggleInv();
              break;
          }
        }
      }
      
      // Limpiar todo (sin cambios)
      function clearAll() {
        currentExpression = '';
        currentPreview = '0';
        parenthesisOpen = false;
        lastSqrtIndex = -1;
        
        if (previewTimeout) {
          clearTimeout(previewTimeout);
          previewTimeout = null;
        }
        
        updateScreen();
      }
      
      // Manejar paréntesis (sin cambios)
      function handleParenthesis() {
        if (parenthesisOpen) {
          addToExpression(')');
          parenthesisOpen = false;
        } else {
          addToExpression('(');
          parenthesisOpen = true;
        }
      }
      
      // ================================================
      // FUNCIONES DE INTERFAZ (sin cambios)
      // ================================================
      
      // Mostrar/ocultar panel científico
      function toggleScientificPanel() {
        scientificButtons.classList.toggle('collapsed');
        
        if (scientificButtons.classList.contains('collapsed')) {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
        } else {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
        }
      }
      
      // Actualizar visibilidad del panel científico según el tamaño de pantalla
      function updateScientificPanelVisibility() {
        if (window.innerWidth >= 768) {
          scientificButtons.classList.remove('collapsed');
          toggleScientificBtn.style.display = 'none';
        } else {
          toggleScientificBtn.style.display = 'flex';
          
          if (scientificButtons.classList.contains('collapsed')) {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
          } else {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
          }
        }
      }
      
      // Manejar entrada por teclado (MODIFICADA para manejar comas)
      function handleKeyboard(event) {
        const key = event.key;
        
        if (['+', '-', '*', '/', 'Enter', 'Escape'].includes(key)) {
          event.preventDefault();
        }
        
        if (key >= '0' && key <= '9') {
          addToExpression(key);
        } else if (key === '.') {
          addToExpression('.');
        } else if (key === '+') {
          addToExpression('+');
        } else if (key === '-') {
          addToExpression('-');
        } else if (key === '*') {
          addToExpression('×');
        } else if (key === '/') {
          addToExpression('÷');
        } else if (key === 'Enter' || key === '=') {
          calculateResult();
        } else if (key === 'Escape' || key === 'Delete') {
          clearAll();
        } else if (key === 'Backspace') {
          backspace();
        } else if (key === '(' || key === ')') {
          handleParenthesis();
        } else if (key === '%') {
          addToExpression('%');
        } else if (key === 'p' || key === 'P') {
          addToExpression('π');
        } else if (key === 'e' || key === 'E') {
          addToExpression('e');
        } else if (key === ',') {
          // Ignoramos comas del teclado, ya que las añadimos automáticamente
          event.preventDefault();
        }
      }
      
      // Inicializar
      function initialize() {
        document.querySelectorAll('.button').forEach(button => {
          button.addEventListener('click', handleButtonClick);
        });
        
        toggleScientificBtn.addEventListener('click', toggleScientificPanel);
        document.addEventListener('keydown', handleKeyboard);
        window.addEventListener('resize', updateScientificPanelVisibility);
        
        updateScientificPanelVisibility();
        updateScreen();
      }
      
      // Verificar si estamos en Telegram WebApp
      const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
      
      if (isTelegramWebApp) {
        Telegram.WebApp.ready();
        console.log('✅ Calculadora Científica para Telegram inicializada');
        Telegram.WebApp.expand();
        Telegram.WebApp.setBackgroundColor('#1e1e2e');
        Telegram.WebApp.setHeaderColor('#1e1e2e');
      }
      
      // Inicializar la calculadora
      initialize();
    });
  </script>
</body>
</html>
