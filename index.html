<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora Científica - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <style>
    /* ... (todo el CSS permanece igual) ... */
  </style>
</head>
<body>
  <!-- Calculadora con diseño nuevo -->
  <div class="calculator">
    <!-- ... (todo el HTML permanece igual) ... -->
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elementos de la calculadora
      const expressionElement = document.getElementById('expression');
      const resultElement = document.getElementById('result');
      const toggleScientificBtn = document.getElementById('toggleScientific');
      const scientificButtons = document.getElementById('scientificButtons');
      const degBtn = document.getElementById('deg-btn');
      const invBtn = document.getElementById('inv-btn');
      
      // Estado de la calculadora
      let currentExpression = '';
      let currentPreview = '0';
      let parenthesisOpen = false;
      let lastSqrtIndex = -1;
      let previewTimeout = null;
      let isDeg = true;
      let isInv = false;
      
      // ================================================
      // NUEVAS FUNCIONES PARA FORMATO DE NÚMEROS
      // ================================================
      
      /**
       * Función para formatear números con separadores de miles
       * Ejemplo: 1000000 -> "1,000,000"
       */
      function formatNumberWithCommas(numStr) {
        // Si es un número en notación científica, lo convertimos primero
        if (numStr.includes('e')) {
          try {
            // Convertimos la notación científica a número completo
            const num = parseFloat(numStr);
            if (isNaN(num)) return numStr;
            
            // Si el número es muy grande o muy pequeño, lo manejamos de forma especial
            if (Math.abs(num) > 1e15 || (Math.abs(num) < 1e-6 && num !== 0)) {
              // Para números extremadamente grandes/pequeños, mantenemos notación científica
              // pero la formateamos mejor
              return num.toExponential(10).replace(/(\.\d*?)(0+)e/, '$1e').replace(/\.e/, 'e');
            }
            
            numStr = num.toString();
          } catch (e) {
            return numStr;
          }
        }
        
        // Separamos parte entera y decimal
        const parts = numStr.split('.');
        let integerPart = parts[0];
        const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
        
        // Añadimos comas cada 3 dígitos en la parte entera
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        return integerPart + decimalPart;
      }
      
      /**
       * Función para formatear una expresión matemática manteniendo los números con comas
       * pero sin afectar a las funciones matemáticas
       */
      function formatExpressionWithCommas(expression) {
        if (!expression) return '';
        
        // Reemplazamos números en la expresión (excluyendo funciones como sin, cos, etc.)
        return expression.replace(/(\d+(?:\.\d+)?)/g, function(match) {
          return formatNumberWithCommas(match);
        });
      }
      
      /**
       * Función para eliminar comas de un número formateado antes de realizar cálculos
       */
      function removeCommas(numStr) {
        return numStr.replace(/,/g, '');
      }
      
      /**
       * Función para manejar números grandes sin notación científica
       * Mantiene el número como string para evitar pérdida de precisión
       */
      function handleLargeNumber(result) {
        try {
          // Si el resultado es un número muy grande, lo mantenemos como string
          if (typeof result === 'number' && (Math.abs(result) > 1e15 || 
              (Math.abs(result) < 1e-6 && result !== 0))) {
            // Para números extremadamente grandes, usamos notación de cadena
            if (Math.abs(result) >= 1e21) {
              return result.toExponential(10);
            }
            // Para números grandes pero manejables, intentamos string normal
            const str = result.toString();
            // Si aún está en notación científica, la convertimos
            if (str.includes('e')) {
              return result.toLocaleString('fullwide', { useGrouping: false });
            }
            return str;
          }
          
          // Para números normales, los convertimos a string
          let str = result.toString();
          
          // Si aparece notación científica, la manejamos
          if (str.includes('e')) {
            // Intentamos convertir a número completo
            try {
              // Usamos toLocaleString para evitar notación científica
              str = result.toLocaleString('fullwide', { useGrouping: false });
            } catch (e) {
              // Si falla, mantenemos la notación científica pero la formateamos
              str = result.toExponential(10)
                .replace(/(\.\d*?)(0+)e/, '$1e')
                .replace(/\.e/, 'e');
            }
          }
          
          return str;
        } catch (e) {
          return result.toString();
        }
      }
      
      // ================================================
      // FUNCIONES MODIFICADAS DE LA CALCULADORA
      // ================================================
      
      // Actualizar la pantalla (MODIFICADA)
      function updateScreen() {
        // Mostramos la expresión con comas para mejor legibilidad
        expressionElement.textContent = formatExpressionWithCommas(currentExpression) || '';
        
        // Mostramos el preview con comas
        resultElement.textContent = formatNumberWithCommas(currentPreview);
      }
      
      // Agregar valor a la expresión (MODIFICADA)
      function addToExpression(value) {
        // Si el valor es un número o punto decimal, lo añadimos directamente
        if (value.match(/[\d\.]/)) {
          currentExpression += value;
        } else {
          // Para operadores y funciones, aseguramos que el último número no tenga comas
          const cleanExpression = removeCommas(currentExpression);
          currentExpression = cleanExpression + value;
        }
        updateScreen();
        updatePreview();
      }
      
      // Borrar último carácter (MODIFICADA)
      function backspace() {
        if (currentExpression.slice(-2) === '√(') {
          lastSqrtIndex = -1;
        }
        
        if (currentExpression.slice(-1) === '(') {
          parenthesisOpen = false;
        } else if (currentExpression.slice(-1) === ')') {
          parenthesisOpen = true;
        }
        
        // Eliminamos el último carácter de la expresión sin comas
        const cleanExpression = removeCommas(currentExpression);
        currentExpression = cleanExpression.slice(0, -1);
        updateScreen();
        updatePreview();
      }
      
      // Actualizar previsualización en tiempo real (MODIFICADA)
      function updatePreview() {
        if (previewTimeout) {
          clearTimeout(previewTimeout);
        }
        
        if (!currentExpression.trim()) {
          currentPreview = '0';
          updateScreen();
          return;
        }
        
        previewTimeout = setTimeout(() => {
          try {
            // Preparamos la expresión para evaluación (sin comas)
            let expressionToEval = removeCommas(currentExpression);
            
            // Balanceamos paréntesis
            expressionToEval = balanceParentheses(expressionToEval);
            
            // Reemplazamos símbolos para math.js
            expressionToEval = expressionToEval
              .replace(/×/g, '*')
              .replace(/÷/g, '/')
              .replace(/π/g, 'pi')
              .replace(/√/g, 'sqrt')
              .replace(/\^/g, '^')
              .replace(/e/g, 'e');
            
            // Manejo de funciones trigonométricas inversas
            if (isInv) {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'asin')
                .replace(/cos/g, 'acos')
                .replace(/tan/g, 'atan');
            } else {
              expressionToEval = expressionToEval
                .replace(/sin/g, 'sin')
                .replace(/cos/g, 'cos')
                .replace(/tan/g, 'tan');
            }
            
            // Conversión grados/radianes
            if (isDeg && !isInv) {
              expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
                function(match, func, angle) {
                  return func + '(' + angle + '*pi/180)';
                });
            }
            
            // Funciones logarítmicas
            expressionToEval = expressionToEval
              .replace(/ln/g, 'log')
              .replace(/log/g, 'log10');
            
            // Factorial
            expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
              return `factorial(${num})`;
            });
            
            // Porcentaje
            expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
              return `(${num}/100)`;
            });
            
            // Evaluamos la expresión
            const result = math.evaluate(expressionToEval);
            
            // Formateamos el resultado para evitar notación científica
            let formattedResult = handleLargeNumber(result);
            
            // Limitamos la longitud para pantalla
            if (formattedResult.length > 20) {
              // Si es un número entero muy largo, lo truncamos pero mantenemos como string
              if (!formattedResult.includes('.') && !formattedResult.includes('e')) {
                if (formattedResult.length > 30) {
                  formattedResult = formattedResult.substring(0, 30) + '...';
                }
              } else if (formattedResult.includes('.')) {
                // Para decimales, limitamos los dígitos decimales
                const [integer, decimal] = formattedResult.split('.');
                if (integer.length > 15) {
                  formattedResult = integer.substring(0, 15) + '...';
                } else if (decimal && decimal.length > 10) {
                  formattedResult = integer + '.' + decimal.substring(0, 10);
                }
              }
            }
            
            currentPreview = formattedResult;
            updateScreen();
            
          } catch (error) {
            currentPreview = '...';
            updateScreen();
          }
        }, 200);
      }
      
      // Calcular resultado final (MODIFICADA)
      function calculateResult() {
        if (!currentExpression) return;
        
        try {
          // Preparamos la expresión para evaluación (sin comas)
          let expressionToEval = removeCommas(currentExpression);
          
          // Balanceamos paréntesis
          expressionToEval = balanceParentheses(expressionToEval);
          
          // Reemplazamos símbolos para math.js
          expressionToEval = expressionToEval
            .replace(/×/g, '*')
            .replace(/÷/g, '/')
            .replace(/π/g, 'pi')
            .replace(/√/g, 'sqrt')
            .replace(/\^/g, '^')
            .replace(/e/g, 'e');
          
          // Manejo de funciones trigonométricas inversas
          if (isInv) {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'asin')
              .replace(/cos/g, 'acos')
              .replace(/tan/g, 'atan');
          } else {
            expressionToEval = expressionToEval
              .replace(/sin/g, 'sin')
              .replace(/cos/g, 'cos')
              .replace(/tan/g, 'tan');
          }
          
          // Conversión grados/radianes
          if (isDeg && !isInv) {
            expressionToEval = expressionToEval.replace(/(sin|cos|tan)\(([^)]+)\)/g, 
              function(match, func, angle) {
                return func + '(' + angle + '*pi/180)';
              });
          }
          
          // Funciones logarítmicas
          expressionToEval = expressionToEval
            .replace(/ln/g, 'log')
            .replace(/log/g, 'log10');
          
          // Factorial
          expressionToEval = expressionToEval.replace(/(\d+)!/g, function(match, num) {
            return `factorial(${num})`;
          });
          
          // Porcentaje
          expressionToEval = expressionToEval.replace(/(\d+(\.\d+)?)%/g, function(match, num) {
            return `(${num}/100)`;
          });
          
          // Evaluamos
          const result = math.evaluate(expressionToEval);
          
          let finalResult = result;
          if (isDeg && isInv) {
            finalResult = result * 180 / Math.PI;
          }
          
          // Formateamos el resultado final
          let formattedResult = handleLargeNumber(finalResult);
          
          // Actualizamos la expresión con el resultado (sin comas para futuros cálculos)
          currentExpression = removeCommas(formattedResult);
          currentPreview = '0';
          parenthesisOpen = false;
          lastSqrtIndex = -1;
          
          updateScreen();
          
        } catch (error) {
          console.error('Error en cálculo:', error);
          currentPreview = 'Error';
          updateScreen();
          
          setTimeout(() => {
            currentPreview = '0';
            currentExpression = '';
            parenthesisOpen = false;
            lastSqrtIndex = -1;
            updateScreen();
          }, 1500);
        }
      }
      
      // ================================================
      // FUNCIONES EXISTENTES (sin cambios)
      // ================================================
      
      // Función para cerrar paréntesis automáticamente
      function balanceParentheses(expression) {
        let openCount = (expression.match(/\(/g) || []).length;
        let closeCount = (expression.match(/\)/g) || []).length;
        
        for (let i = 0; i < (openCount - closeCount); i++) {
          expression += ')';
        }
        
        return expression;
      }
      
      // Función especial para raíz cuadrada
      function handleSquareRoot() {
        if (lastSqrtIndex !== -1) {
          const afterSqrt = currentExpression.substring(lastSqrtIndex);
          if (!afterSqrt.includes(')')) {
            addToExpression(')');
            lastSqrtIndex = -1;
          }
        }
        
        addToExpression('√(');
        lastSqrtIndex = currentExpression.length - 2;
        parenthesisOpen = true;
      }
      
      // Toggle grados/radianes
      function toggleDeg() {
        isDeg = !isDeg;
        const degButtons = document.querySelectorAll('[data-action="deg"]');
        degButtons.forEach(btn => {
          btn.textContent = isDeg ? 'Deg' : 'Rad';
        });
      }
      
      // Toggle funciones inversas
      function toggleInv() {
        isInv = !isInv;
        const invButtons = document.querySelectorAll('[data-action="inv"]');
        const sinButtons = document.querySelectorAll('[data-action="sin"]');
        const cosButtons = document.querySelectorAll('[data-action="cos"]');
        const tanButtons = document.querySelectorAll('[data-action="tan"]');
        
        invButtons.forEach(btn => {
          btn.style.backgroundColor = isInv ? '#f72585' : '';
        });
        
        if (isInv) {
          sinButtons.forEach(btn => btn.textContent = 'sin⁻¹');
          cosButtons.forEach(btn => btn.textContent = 'cos⁻¹');
          tanButtons.forEach(btn => btn.textContent = 'tan⁻¹');
        } else {
          sinButtons.forEach(btn => btn.textContent = 'sin');
          cosButtons.forEach(btn => btn.textContent = 'cos');
          tanButtons.forEach(btn => btn.textContent = 'tan');
        }
      }
      
      // Manejar clics en botones
      function handleButtonClick(event) {
        const button = event.target.closest('.button');
        if (!button) return;
        
        button.style.transform = 'translateY(2px) scale(0.98)';
        setTimeout(() => {
          button.style.transform = '';
        }, 150);
        
        const value = button.getAttribute('data-value');
        const action = button.getAttribute('data-action');
        
        if (value) {
          addToExpression(value);
        } else if (action) {
          switch(action) {
            case 'clear':
              clearAll();
              break;
            case 'backspace':
              backspace();
              break;
            case 'equals':
              calculateResult();
              break;
            case 'divide':
              addToExpression('÷');
              break;
            case 'multiply':
              addToExpression('×');
              break;
            case 'add':
              addToExpression('+');
              break;
            case 'subtract':
              addToExpression('-');
              break;
            case 'parenthesis':
              handleParenthesis();
              break;
            case 'percentage':
              addToExpression('%');
              break;
            case 'sqrt':
              handleSquareRoot();
              break;
            case 'pi':
              addToExpression('π');
              break;
            case 'e':
              addToExpression('e');
              break;
            case 'pow':
              addToExpression('^');
              break;
            case 'factorial':
              addToExpression('!');
              break;
            case 'sin':
              addToExpression(isInv ? 'asin(' : 'sin(');
              parenthesisOpen = true;
              break;
            case 'cos':
              addToExpression(isInv ? 'acos(' : 'cos(');
              parenthesisOpen = true;
              break;
            case 'tan':
              addToExpression(isInv ? 'atan(' : 'tan(');
              parenthesisOpen = true;
              break;
            case 'ln':
              addToExpression('ln(');
              parenthesisOpen = true;
              break;
            case 'log':
              addToExpression('log(');
              parenthesisOpen = true;
              break;
            case 'deg':
              toggleDeg();
              break;
            case 'inv':
              toggleInv();
              break;
          }
        }
      }
      
      // Limpiar todo (sin cambios)
      function clearAll() {
        currentExpression = '';
        currentPreview = '0';
        parenthesisOpen = false;
        lastSqrtIndex = -1;
        
        if (previewTimeout) {
          clearTimeout(previewTimeout);
          previewTimeout = null;
        }
        
        updateScreen();
      }
      
      // Manejar paréntesis (sin cambios)
      function handleParenthesis() {
        if (parenthesisOpen) {
          addToExpression(')');
          parenthesisOpen = false;
        } else {
          addToExpression('(');
          parenthesisOpen = true;
        }
      }
      
      // ================================================
      // FUNCIONES DE INTERFAZ (sin cambios)
      // ================================================
      
      // Mostrar/ocultar panel científico
      function toggleScientificPanel() {
        scientificButtons.classList.toggle('collapsed');
        
        if (scientificButtons.classList.contains('collapsed')) {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
        } else {
          toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
        }
      }
      
      // Actualizar visibilidad del panel científico según el tamaño de pantalla
      function updateScientificPanelVisibility() {
        if (window.innerWidth >= 768) {
          scientificButtons.classList.remove('collapsed');
          toggleScientificBtn.style.display = 'none';
        } else {
          toggleScientificBtn.style.display = 'flex';
          
          if (scientificButtons.classList.contains('collapsed')) {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︾</span>';
          } else {
            toggleScientificBtn.innerHTML = '<span>Funciones científicas ︽</span>';
          }
        }
      }
      
      // Manejar entrada por teclado (MODIFICADA para manejar comas)
      function handleKeyboard(event) {
        const key = event.key;
        
        if (['+', '-', '*', '/', 'Enter', 'Escape'].includes(key)) {
          event.preventDefault();
        }
        
        if (key >= '0' && key <= '9') {
          addToExpression(key);
        } else if (key === '.') {
          addToExpression('.');
        } else if (key === '+') {
          addToExpression('+');
        } else if (key === '-') {
          addToExpression('-');
        } else if (key === '*') {
          addToExpression('×');
        } else if (key === '/') {
          addToExpression('÷');
        } else if (key === 'Enter' || key === '=') {
          calculateResult();
        } else if (key === 'Escape' || key === 'Delete') {
          clearAll();
        } else if (key === 'Backspace') {
          backspace();
        } else if (key === '(' || key === ')') {
          handleParenthesis();
        } else if (key === '%') {
          addToExpression('%');
        } else if (key === 'p' || key === 'P') {
          addToExpression('π');
        } else if (key === 'e' || key === 'E') {
          addToExpression('e');
        } else if (key === ',') {
          // Ignoramos comas del teclado, ya que las añadimos automáticamente
          event.preventDefault();
        }
      }
      
      // Inicializar
      function initialize() {
        document.querySelectorAll('.button').forEach(button => {
          button.addEventListener('click', handleButtonClick);
        });
        
        toggleScientificBtn.addEventListener('click', toggleScientificPanel);
        document.addEventListener('keydown', handleKeyboard);
        window.addEventListener('resize', updateScientificPanelVisibility);
        
        updateScientificPanelVisibility();
        updateScreen();
      }
      
      // Verificar si estamos en Telegram WebApp
      const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
      
      if (isTelegramWebApp) {
        Telegram.WebApp.ready();
        console.log('✅ Calculadora Científica para Telegram inicializada');
        Telegram.WebApp.expand();
        Telegram.WebApp.setBackgroundColor('#1e1e2e');
        Telegram.WebApp.setHeaderColor('#1e1e2e');
      }
      
      // Inicializar la calculadora
      initialize();
    });
  </script>
</body>
</html>
